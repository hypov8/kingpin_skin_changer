#NoTrayIcon
#Region ;**** Directives created by AutoIt3Wrapper_GUI ****
#AutoIt3Wrapper_Icon=D:\_code_\icon\star_icon.ico
#AutoIt3Wrapper_Outfile=S:\dev_code\models-\kp_skinChanger\kingpin_skin_changer.exe
#AutoIt3Wrapper_UseX64=n
#AutoIt3Wrapper_Res_Description=Kingpin Skin Changer v1.0.5
#AutoIt3Wrapper_Res_Fileversion=1.0.5.0
#AutoIt3Wrapper_Res_File_Add=S:\dev_code\models-\kp_skinChanger\_sprites\0.bmp,rt_bitmap,spr_0
#AutoIt3Wrapper_Res_File_Add=S:\dev_code\models-\kp_skinChanger\_sprites\1.bmp,rt_bitmap,spr_1
#AutoIt3Wrapper_Res_File_Add=S:\dev_code\models-\kp_skinChanger\_sprites\2.bmp,rt_bitmap,spr_2
#AutoIt3Wrapper_Res_File_Add=S:\dev_code\models-\kp_skinChanger\_sprites\3.bmp,rt_bitmap,spr_3
#AutoIt3Wrapper_Res_File_Add=S:\dev_code\models-\kp_skinChanger\_sprites\4.bmp,rt_bitmap,spr_4
#AutoIt3Wrapper_Res_File_Add=S:\dev_code\models-\kp_skinChanger\_sprites\5.bmp,rt_bitmap,spr_5
#AutoIt3Wrapper_Res_File_Add=S:\dev_code\models-\kp_skinChanger\_sprites\6.bmp,rt_bitmap,spr_6
#AutoIt3Wrapper_Res_File_Add=S:\dev_code\models-\kp_skinChanger\_sprites\7.bmp,rt_bitmap,spr_7
#AutoIt3Wrapper_Res_File_Add=S:\dev_code\models-\kp_skinChanger\_sprites\8.bmp,rt_bitmap,spr_8
#AutoIt3Wrapper_Res_File_Add=S:\dev_code\models-\kp_skinChanger\_sprites\9.bmp,rt_bitmap,spr_9
#AutoIt3Wrapper_Res_File_Add=S:\dev_code\models-\kp_skinChanger\_sprites\10.bmp,rt_bitmap,spr_10
#AutoIt3Wrapper_Res_File_Add=S:\dev_code\models-\kp_skinChanger\_sprites\11.bmp,rt_bitmap,spr_11
#AutoIt3Wrapper_Res_File_Add=S:\dev_code\models-\kp_skinChanger\_sprites\12.bmp,rt_bitmap,spr_12
#AutoIt3Wrapper_Res_File_Add=S:\dev_code\models-\kp_skinChanger\_sprites\13.bmp,rt_bitmap,spr_13
#AutoIt3Wrapper_Res_File_Add=S:\dev_code\models-\kp_skinChanger\_sprites\14.bmp,rt_bitmap,spr_14
#AutoIt3Wrapper_Res_File_Add=S:\dev_code\models-\kp_skinChanger\_sprites\15.bmp,rt_bitmap,spr_15
#AutoIt3Wrapper_Res_File_Add=S:\dev_code\models-\kp_skinChanger\_sprites\16.bmp,rt_bitmap,spr_16
#AutoIt3Wrapper_Res_File_Add=S:\dev_code\models-\kp_skinChanger\_sprites\17.bmp,rt_bitmap,spr_17
#AutoIt3Wrapper_Res_File_Add=S:\dev_code\models-\kp_skinChanger\_sprites\18.bmp,rt_bitmap,spr_18
#AutoIt3Wrapper_Res_File_Add=S:\dev_code\models-\kp_skinChanger\_sprites\19.bmp,rt_bitmap,spr_19
#AutoIt3Wrapper_Res_File_Add=S:\dev_code\models-\kp_skinChanger\_sprites\20.bmp,rt_bitmap,spr_20
#AutoIt3Wrapper_Res_File_Add=S:\dev_code\models-\kp_skinChanger\_sprites\21.bmp,rt_bitmap,spr_21
#AutoIt3Wrapper_Res_File_Add=S:\dev_code\models-\kp_skinChanger\_sprites\22.bmp,rt_bitmap,spr_22
#AutoIt3Wrapper_Res_File_Add=S:\dev_code\models-\kp_skinChanger\_sprites\23.bmp,rt_bitmap,spr_23
#AutoIt3Wrapper_Res_File_Add=S:\dev_code\models-\kp_skinChanger\_sprites\24.bmp,rt_bitmap,spr_24
#AutoIt3Wrapper_Res_File_Add=S:\dev_code\models-\kp_skinChanger\_sprites\25.bmp,rt_bitmap,spr_25
#AutoIt3Wrapper_Res_File_Add=S:\dev_code\models-\kp_skinChanger\_sprites\26.bmp,rt_bitmap,spr_26
#AutoIt3Wrapper_Res_File_Add=S:\dev_code\models-\kp_skinChanger\_sprites\27.bmp,rt_bitmap,spr_27
#AutoIt3Wrapper_Res_File_Add=S:\dev_code\models-\kp_skinChanger\_sprites\28.bmp,rt_bitmap,spr_28
#AutoIt3Wrapper_Res_File_Add=S:\dev_code\models-\kp_skinChanger\_sprites\29.bmp,rt_bitmap,spr_29
#AutoIt3Wrapper_Res_File_Add=S:\dev_code\models-\kp_skinChanger\_sprites\30.bmp,rt_bitmap,spr_30
#AutoIt3Wrapper_Res_File_Add=S:\dev_code\models-\kp_skinChanger\_sprites\31.bmp,rt_bitmap,spr_31
#AutoIt3Wrapper_Res_File_Add=S:\dev_code\models-\kp_skinChanger\_sprites\32.bmp,rt_bitmap,spr_32
#AutoIt3Wrapper_Res_File_Add=S:\dev_code\models-\kp_skinChanger\_sprites\33.bmp,rt_bitmap,spr_33
#AutoIt3Wrapper_Res_File_Add=S:\dev_code\models-\kp_skinChanger\_sprites\34.bmp,rt_bitmap,spr_34
#AutoIt3Wrapper_Res_File_Add=S:\dev_code\models-\kp_skinChanger\_sprites\35.bmp,rt_bitmap,spr_35
#AutoIt3Wrapper_Res_File_Add=S:\dev_code\models-\kp_skinChanger\_sprites\36.bmp,rt_bitmap,spr_36
#AutoIt3Wrapper_Res_File_Add=S:\dev_code\models-\kp_skinChanger\_sprites\37.bmp,rt_bitmap,spr_37
#AutoIt3Wrapper_Res_File_Add=S:\dev_code\models-\kp_skinChanger\_sprites\38.bmp,rt_bitmap,spr_38
#AutoIt3Wrapper_Res_File_Add=S:\dev_code\models-\kp_skinChanger\_sprites\39.bmp,rt_bitmap,spr_39
#AutoIt3Wrapper_Res_File_Add=S:\dev_code\models-\kp_skinChanger\_sprites\40.bmp,rt_bitmap,spr_40
#AutoIt3Wrapper_Res_File_Add=S:\dev_code\models-\kp_skinChanger\_sprites\41.bmp,rt_bitmap,spr_41
#AutoIt3Wrapper_Res_File_Add=S:\dev_code\models-\kp_skinChanger\_sprites\42.bmp,rt_bitmap,spr_42
#AutoIt3Wrapper_Res_File_Add=S:\dev_code\models-\kp_skinChanger\_sprites\43.bmp,rt_bitmap,spr_43
#AutoIt3Wrapper_Res_File_Add=S:\dev_code\models-\kp_skinChanger\_sprites\44.bmp,rt_bitmap,spr_44
#AutoIt3Wrapper_Res_File_Add=S:\dev_code\models-\kp_skinChanger\_sprites\45.bmp,rt_bitmap,spr_45
#AutoIt3Wrapper_Res_File_Add=S:\dev_code\models-\kp_skinChanger\_sprites\46.bmp,rt_bitmap,spr_46
#AutoIt3Wrapper_Res_File_Add=S:\dev_code\models-\kp_skinChanger\_sprites\47.bmp,rt_bitmap,spr_47
#AutoIt3Wrapper_Res_File_Add=S:\dev_code\models-\kp_skinChanger\_sprites\48.bmp,rt_bitmap,spr_48
#EndRegion ;**** Directives created by AutoIt3Wrapper_GUI ****
;~ #AutoIt3Wrapper_Res_File_Add=S:\dev_code\models-\kp_skinChanger\_sprites\up.bmp,rt_bitmap,btn_up
;~ #AutoIt3Wrapper_Res_File_Add=S:\dev_code\models-\kp_skinChanger\_sprites\dn.bmp,rt_bitmap,btn_dn
;~ #AutoIt3Wrapper_Res_File_Add=S:\dev_code\models-\kp_skinChanger\_sprites\up_.bmp,rt_bitmap,btn_up_
;~ #AutoIt3Wrapper_Res_File_Add=S:\dev_code\models-\kp_skinChanger\_sprites\dn_.bmp,rt_bitmap,btn_dn_

; kingpin skin changer v1.0
;
; update v1.0.1
;    added drag file onto window. support for import, export and textur imput boxes
;    added option to backup file
;    added sprite sfx editor
;    disabled ESC closing the program
;    made reader more rebust by reading header offsets.
;    fixed messagebox not centre to program

; update v1.0.2
;    Fixed bug with reset button not reseting image
;    added check for models with zero skins in use
;    added editing of scale/position using bounding box

; update v1.0.3
;	added scale buttons to center model and drop to floor

; update v1.0.4
; 	fixed bug in sprite frame range (if all frames are set to on)

; update v1.0.5
;   added q3 support


AutoItSetOption("MustDeclareVars", 1)

#include <ButtonConstants.au3>
#include <EditConstants.au3>
#include <GUIConstantsEx.au3>
#include <WindowsConstants.au3>
#include <String.au3>
#include <FileConstants.au3>
#include <WinAPIFiles.au3>
#include <TabConstants.au3>
#Include <WinAPIEx.au3>
#include <ComboConstants.au3>
#include <StaticConstants.au3>
#include <UpDownConstants.au3>
#include <GuiComboBox.au3>
#include <Array.au3>
#include <File.au3>
#include <WinAPIHObj.au3>
Opt("GUIOnEventMode", 1)
Opt("GUICloseOnESC", 0)


#Region ### START Koda GUI section ### Form=c:\programs\codeing\autoit-v3\scite\koda\dave\kp\model_fix.kxf
Global $KPModelSkins = GUICreate("Kingpin Model Skin Changer v1.0.5", 494, 510, -1, -1, -1, BitOR($WS_EX_ACCEPTFILES,$WS_EX_WINDOWEDGE))
GUISetOnEvent($GUI_EVENT_CLOSE, "KPModelSkinsClose")
Global $Group3 = GUICtrlCreateGroup("#2. Output Model Path", 4, 64, 381, 57)
Global $in_model_export = GUICtrlCreateInput("", 96, 88, 277, 21, BitOR($GUI_SS_DEFAULT_INPUT,$ES_READONLY))
Global $btn_export_file = GUICtrlCreateButton("Save name..", 12, 84, 77, 29)
GUICtrlSetTip(-1, "Set output filename different to import.")
GUICtrlSetOnEvent(-1, "btn_export_fileClick")
GUICtrlCreateGroup("", -99, -99, 1, 1)
Global $Group1 = GUICtrlCreateGroup("#1. Open Model", 4, 4, 381, 57)
Global $btn_import = GUICtrlCreateButton("Import..", 12, 24, 77, 29)
GUICtrlSetTip(-1, "Output File Name will also be updated")
GUICtrlSetOnEvent(-1, "btn_importClick")
Global $in_model_import = GUICtrlCreateInput("", 96, 28, 277, 21, BitOR($GUI_SS_DEFAULT_INPUT,$ES_READONLY))
GUICtrlCreateGroup("", -99, -99, 1, 1)
Global $Group6 = GUICtrlCreateGroup("#3. Skins/Sprite/Scale", 4, 124, 485, 381, -1, $WS_EX_TRANSPARENT)
Global $tabs = GUICtrlCreateTab(8, 144, 477, 357, $TCS_BUTTONS)
Global $skin16 = GUICtrlCreateTabItem("Skins 1-16")
Global $btn_skin_1 = GUICtrlCreateButton("Skin 1", 12, 176, 61, 20)
GUICtrlSetOnEvent(-1, "btn_skin_1Click")
Global $btn_skin_2 = GUICtrlCreateButton("Skin 2", 12, 196, 61, 20)
GUICtrlSetOnEvent(-1, "btn_skin_2Click")
Global $btn_skin_3 = GUICtrlCreateButton("Skin 3", 12, 216, 61, 20)
GUICtrlSetOnEvent(-1, "btn_skin_3Click")
Global $btn_skin_4 = GUICtrlCreateButton("Skin 4", 12, 236, 61, 20)
GUICtrlSetOnEvent(-1, "btn_skin_4Click")
Global $btn_skin_5 = GUICtrlCreateButton("Skin 5", 12, 256, 61, 20)
GUICtrlSetOnEvent(-1, "btn_skin_5Click")
Global $btn_skin_6 = GUICtrlCreateButton("Skin 6", 12, 276, 61, 20)
GUICtrlSetOnEvent(-1, "btn_skin_6Click")
Global $btn_skin_7 = GUICtrlCreateButton("Skin 7", 12, 296, 61, 20)
GUICtrlSetOnEvent(-1, "btn_skin_7Click")
Global $btn_skin_8 = GUICtrlCreateButton("Skin 8", 12, 316, 61, 20)
GUICtrlSetOnEvent(-1, "btn_skin_8Click")
Global $btn_skin_9 = GUICtrlCreateButton("Skin 9", 12, 336, 61, 20)
GUICtrlSetOnEvent(-1, "btn_skin_9Click")
Global $btn_skin_10 = GUICtrlCreateButton("Skin 10", 12, 356, 61, 20)
GUICtrlSetOnEvent(-1, "btn_skin_10Click")
Global $btn_skin_11 = GUICtrlCreateButton("Skin 11", 12, 376, 61, 20)
GUICtrlSetOnEvent(-1, "btn_skin_11Click")
Global $btn_skin_12 = GUICtrlCreateButton("Skin 12", 12, 396, 61, 20)
GUICtrlSetOnEvent(-1, "btn_skin_12Click")
Global $btn_skin_13 = GUICtrlCreateButton("Skin 13", 12, 416, 61, 20)
GUICtrlSetOnEvent(-1, "btn_skin_13Click")
Global $btn_skin_14 = GUICtrlCreateButton("Skin 14", 12, 436, 61, 20)
GUICtrlSetOnEvent(-1, "btn_skin_14Click")
Global $btn_skin_15 = GUICtrlCreateButton("Skin 15", 12, 456, 61, 20)
GUICtrlSetOnEvent(-1, "btn_skin_15Click")
Global $btn_skin_16 = GUICtrlCreateButton("Skin 16", 12, 476, 61, 20)
GUICtrlSetOnEvent(-1, "btn_skin_16Click")
Global $in_skin_1 = GUICtrlCreateInput("", 80, 176, 400, 21)
Global $in_skin_2 = GUICtrlCreateInput("", 80, 196, 400, 21)
Global $in_skin_3 = GUICtrlCreateInput("", 80, 216, 400, 21)
Global $in_skin_4 = GUICtrlCreateInput("", 80, 236, 400, 21)
Global $in_skin_5 = GUICtrlCreateInput("", 80, 256, 400, 21)
Global $in_skin_6 = GUICtrlCreateInput("", 80, 276, 400, 21)
Global $in_skin_7 = GUICtrlCreateInput("", 80, 296, 400, 21)
Global $in_skin_8 = GUICtrlCreateInput("", 80, 316, 400, 21)
Global $in_skin_9 = GUICtrlCreateInput("", 80, 336, 400, 21)
Global $in_skin_10 = GUICtrlCreateInput("", 80, 356, 400, 21)
Global $in_skin_11 = GUICtrlCreateInput("", 80, 376, 400, 21)
Global $in_skin_12 = GUICtrlCreateInput("", 80, 396, 400, 21)
Global $in_skin_13 = GUICtrlCreateInput("", 80, 416, 400, 21)
Global $in_skin_14 = GUICtrlCreateInput("", 80, 436, 400, 21)
Global $in_skin_15 = GUICtrlCreateInput("", 80, 456, 400, 21)
Global $in_skin_16 = GUICtrlCreateInput("", 80, 476, 400, 21)
Global $skin32 = GUICtrlCreateTabItem("Skins 17-32")
Global $btn_skin_17 = GUICtrlCreateButton("Skin 17", 12, 176, 61, 20)
GUICtrlSetOnEvent(-1, "btn_skin_17Click")
Global $btn_skin_18 = GUICtrlCreateButton("Skin 18", 12, 196, 61, 20)
GUICtrlSetOnEvent(-1, "btn_skin_18Click")
Global $btn_skin_19 = GUICtrlCreateButton("Skin 19", 12, 216, 61, 20)
GUICtrlSetOnEvent(-1, "btn_skin_19Click")
Global $btn_skin_20 = GUICtrlCreateButton("Skin 20", 12, 236, 61, 20)
GUICtrlSetOnEvent(-1, "btn_skin_20Click")
Global $btn_skin_21 = GUICtrlCreateButton("Skin 21", 12, 256, 61, 20)
GUICtrlSetOnEvent(-1, "btn_skin_21Click")
Global $btn_skin_22 = GUICtrlCreateButton("Skin 22", 12, 276, 61, 20)
GUICtrlSetOnEvent(-1, "btn_skin_22Click")
Global $btn_skin_23 = GUICtrlCreateButton("Skin 23", 12, 296, 61, 20)
GUICtrlSetOnEvent(-1, "btn_skin_23Click")
Global $btn_skin_24 = GUICtrlCreateButton("Skin 24", 12, 316, 61, 20)
GUICtrlSetOnEvent(-1, "btn_skin_24Click")
Global $btn_skin_25 = GUICtrlCreateButton("Skin 25", 12, 336, 61, 20)
GUICtrlSetOnEvent(-1, "btn_skin_25Click")
Global $btn_skin_26 = GUICtrlCreateButton("Skin 26", 12, 356, 61, 20)
GUICtrlSetOnEvent(-1, "btn_skin_26Click")
Global $btn_skin_27 = GUICtrlCreateButton("Skin 27", 12, 376, 61, 20)
GUICtrlSetOnEvent(-1, "btn_skin_27Click")
Global $btn_skin_28 = GUICtrlCreateButton("Skin 28", 12, 396, 61, 20)
GUICtrlSetOnEvent(-1, "btn_skin_28Click")
Global $btn_skin_29 = GUICtrlCreateButton("Skin 29", 12, 416, 61, 20)
GUICtrlSetOnEvent(-1, "btn_skin_29Click")
Global $btn_skin_30 = GUICtrlCreateButton("Skin 30", 12, 436, 61, 20)
GUICtrlSetOnEvent(-1, "btn_skin_30Click")
Global $btn_skin_31 = GUICtrlCreateButton("Skin 31", 12, 456, 61, 20)
GUICtrlSetOnEvent(-1, "btn_skin_31Click")
Global $btn_skin_32 = GUICtrlCreateButton("Skin 32", 12, 476, 61, 20)
GUICtrlSetOnEvent(-1, "btn_skin_32Click")
Global $in_skin_17 = GUICtrlCreateInput("", 80, 176, 400, 21)
Global $in_skin_18 = GUICtrlCreateInput("", 80, 196, 400, 21)
Global $in_skin_19 = GUICtrlCreateInput("", 80, 216, 400, 21)
Global $in_skin_20 = GUICtrlCreateInput("", 80, 236, 400, 21)
Global $in_skin_21 = GUICtrlCreateInput("", 80, 256, 400, 21)
Global $in_skin_22 = GUICtrlCreateInput("", 80, 276, 400, 21)
Global $in_skin_23 = GUICtrlCreateInput("", 80, 296, 400, 21)
Global $in_skin_24 = GUICtrlCreateInput("", 80, 316, 400, 21)
Global $in_skin_25 = GUICtrlCreateInput("", 80, 336, 400, 21)
Global $in_skin_26 = GUICtrlCreateInput("", 80, 356, 400, 21)
Global $in_skin_27 = GUICtrlCreateInput("", 80, 376, 400, 21)
Global $in_skin_28 = GUICtrlCreateInput("", 80, 396, 400, 21)
Global $in_skin_29 = GUICtrlCreateInput("", 80, 416, 400, 21)
Global $in_skin_30 = GUICtrlCreateInput("", 80, 436, 400, 21)
Global $in_skin_31 = GUICtrlCreateInput("", 80, 456, 400, 21)
Global $in_skin_32 = GUICtrlCreateInput("", 80, 476, 400, 21)
Global $tabSprite = GUICtrlCreateTabItem("Sprite")
Global $Group5 = GUICtrlCreateGroup("Sprite Settings", 14, 172, 465, 323)
Global $Input1_flags = GUICtrlCreateInput("0", 90, 224, 61, 21, BitOR($GUI_SS_DEFAULT_INPUT,$ES_READONLY,$ES_NUMBER))
GUICtrlSetTip(-1, "Flags.")
Global $Input10_rand_scale = GUICtrlCreateInput("0", 90, 464, 62, 21)
Global $Updown10_randScale = GUICtrlCreateUpdown($Input10_rand_scale)
GUICtrlSetLimit(-1, 2048, 0)
GUICtrlSetTip(-1, "Random time scale (fadein and lifetime will be multiplied by (x * 0.5), where x is a random number between -1 and 1. (type=float)")
Global $Input9_lifetime = GUICtrlCreateInput("0", 90, 440, 62, 21)
Global $Updown9_lifetime = GUICtrlCreateUpdown($Input9_lifetime)
GUICtrlSetLimit(-1, 2048, 0)
GUICtrlSetTip(-1, "How long will the sprite will be shown before it is gone. (type=float)")
Global $Input8_fade_in = GUICtrlCreateInput("0", 90, 416, 62, 21)
Global $Updown8_fadein = GUICtrlCreateUpdown($Input8_fade_in)
GUICtrlSetLimit(-1, 2048, 0)
GUICtrlSetTip(-1, "Fade in time. (type=float)")
Global $Input7_end_alpha = GUICtrlCreateInput("0", 90, 392, 62, 21)
Global $Updown7_endAlpha = GUICtrlCreateUpdown($Input7_end_alpha)
GUICtrlSetLimit(-1, 2048, 0)
GUICtrlSetTip(-1, "The end of a sprite with how much alpha the sprite has. (type=float)")
Global $Input6_start_alpha = GUICtrlCreateInput("0", 90, 368, 62, 21)
Global $Updown6_startAlpha = GUICtrlCreateUpdown($Input6_start_alpha)
GUICtrlSetLimit(-1, 2048, 0)
GUICtrlSetTip(-1, "The start of a sprite with how much alpha the sprite has.(Float)")
Global $Input5_randTime = GUICtrlCreateInput("0", 90, 344, 62, 21, BitOR($GUI_SS_DEFAULT_INPUT,$ES_NUMBER))
Global $Updown5_randTime = GUICtrlCreateUpdown($Input5_randTime)
GUICtrlSetLimit(-1, 100, 1)
GUICtrlSetTip(-1, "Random spawn interval (sprite will be spawned 50% of the time) (type=float)")
Global $Input4_time = GUICtrlCreateInput("0", 90, 320, 62, 21, BitOR($GUI_SS_DEFAULT_INPUT,$ES_NUMBER))
Global $Updown4_time = GUICtrlCreateUpdown($Input4_time)
GUICtrlSetLimit(-1, 2048, 0)
GUICtrlSetTip(-1, "Spawn interval. 2=0.2 seconds (type=integer)")
Global $Input3_gravity = GUICtrlCreateInput("0", 90, 296, 62, 21)
Global $Updown3_gravity = GUICtrlCreateUpdown($Input3_gravity)
GUICtrlSetLimit(-1, 2048, 0)
GUICtrlSetTip(-1, "Use gravity for sprite. (type=integer)")
Global $Input2_speed = GUICtrlCreateInput("0", 90, 272, 62, 21, BitOR($GUI_SS_DEFAULT_INPUT,$ES_NUMBER))
Global $Updown2_speed = GUICtrlCreateUpdown($Input2_speed)
GUICtrlSetLimit(-1, 2048, 1)
GUICtrlSetTip(-1, "Velocity/Speed (type=integer)")
Global $Combo2_direction = GUICtrlCreateCombo("", 90, 248, 63, 25, BitOR($CBS_DROPDOWNLIST,$CBS_AUTOHSCROLL))
GUICtrlSetData(-1, "0: UP|1: Use Face/Vert Direction", "0: UP")
GUICtrlSetTip(-1, "Direction sprite will face")
Global $Label6 = GUICtrlCreateLabel("Gravity/Delay", 18, 298, 67, 17, $SS_RIGHT)
Global $Label5 = GUICtrlCreateLabel("Speed", 26, 274, 59, 17, $SS_RIGHT)
GUICtrlSetTip(-1, "Use gravity for sprite")
Global $Label4 = GUICtrlCreateLabel("Direction", 26, 250, 59, 17, $SS_RIGHT)
Global $Combo1_SFX_Type = GUICtrlCreateCombo("", 90, 200, 63, 25, BitOR($GUI_SS_DEFAULT_COMBO,$CBS_SIMPLE))
GUICtrlSetData(-1, "0: Blood (Called SFX_SPRITE_SURF_BLOOD1 in code)|1: Bullet Hole (Called SFX_SPRITE_SURF_BULLET1 in code)|2: Riple (Called SFX_SPRITE_SURF_RIPPLE in code)|5: Blood Pool (Called SFX_SPRITE_SURF_BLOOD_POOL in code)|6: Blood Splat|7: Blood Drop|8: Smoke Small|9: Fire|10: Carona|16: Same as 9:|17: Carona Amber|18: Carona Red|19: Carona Green|20: Carona Blue|21: Rain|22: Smoke Small R (Red? but is not red. unfisched texture)|23: Sniper 1c (Missing texture)|24: Sniper 2 (Missing texture)|25: Same as 2.|71: Blood 1|72: Blood 1b|73: Blood 1c|74: Blood 1d|75: Blood 1e|76: Blood 1f|77: Blood 1g|78: Blood 1h|79: Blood 1i|80: Muzzle flash 3|100: Muzzle flash HMG (Used for HMG)|101: Muzzle flash 1 (Used for Pistol)|102: Muzzle flash 2 (Used for Tommygun)|103: Same as 80 (Used for Shotgun)|104: Muzzle flash 4 (Used for Flamethrower)|106: Muzzle flash 1a|107: Muzzle flash 2a|108: Muzzle flash 2b|110: Explode 1|111: Explode 2|116: Smoke Animated|120: Flame Thrower|121: Return error texture.|122: Flame Thrower Blue|123: Same as 121.|124: Splash 1|125: Splash 2|126: Splash 3|127: Splash 4|128: Firewall")
GUICtrlSetTip(-1, "Sprite image to use")
GUICtrlSetOnEvent(-1, "Combo1_SFX_TypeChange")
Global $Label2 = GUICtrlCreateLabel("SFX Type", 26, 202, 59, 17, $SS_RIGHT)
Global $Label7 = GUICtrlCreateLabel("Time 0.1s *", 26, 321, 59, 17, $SS_RIGHT)
Global $Label8 = GUICtrlCreateLabel("Spawn %", 18, 346, 67, 17, $SS_RIGHT)
GUICtrlSetTip(-1, "Random spawn percent.")
Global $Label9 = GUICtrlCreateLabel("Start Alpha", 26, 370, 59, 17, $SS_RIGHT)
Global $Label10 = GUICtrlCreateLabel("End Alpha", 26, 394, 59, 17, $SS_RIGHT)
Global $Label11 = GUICtrlCreateLabel("Fade In", 26, 418, 59, 17, $SS_RIGHT)
GUICtrlSetTip(-1, "0.0 >")
Global $Label12 = GUICtrlCreateLabel("Lifetime", 26, 442, 59, 17, $SS_RIGHT)
GUICtrlSetTip(-1, "Time sprite will exist for. 0.1>")
Global $Label13 = GUICtrlCreateLabel("Rand Scale", 26, 466, 59, 17, $SS_RIGHT)
Global $Input11_start_width = GUICtrlCreateInput("0", 250, 200, 62, 21)
Global $Updown11_startWidth = GUICtrlCreateUpdown($Input11_start_width)
GUICtrlSetLimit(-1, 2048, 0)
GUICtrlSetTip(-1, "Start size of sprite in width. (type=float)")
Global $Label14 = GUICtrlCreateLabel("Start Width", 192, 202, 53, 17, $SS_RIGHT)
Global $Input12_end_width = GUICtrlCreateInput("0", 250, 224, 62, 21)
Global $Updown12_endWidth = GUICtrlCreateUpdown($Input12_end_width)
GUICtrlSetLimit(-1, 2048, 0)
GUICtrlSetTip(-1, "End size of sprite in width. (type=float)")
Global $Input13_start_height = GUICtrlCreateInput("0", 250, 248, 62, 21)
Global $Updown13_startHeight = GUICtrlCreateUpdown($Input13_start_height)
GUICtrlSetLimit(-1, 2048, 0)
GUICtrlSetTip(-1, "Start size of sprite in height. (type=float)")
Global $Input14_end_height = GUICtrlCreateInput("0", 250, 272, 62, 21)
Global $Updown14_end_height = GUICtrlCreateUpdown($Input14_end_height)
GUICtrlSetLimit(-1, 2048, 0)
GUICtrlSetTip(-1, "End size of sprite in height. (type=float)")
Global $Input15_rand_w_h = GUICtrlCreateInput("0", 250, 296, 62, 21)
Global $Updown15_randWH = GUICtrlCreateUpdown($Input15_rand_w_h)
GUICtrlSetLimit(-1, 2048, 0)
GUICtrlSetTip(-1, "Random size scale (same as random time scale, but effects only sizes) (type=float)")
Global $Label15 = GUICtrlCreateLabel("End Width", 192, 226, 53, 17, $SS_RIGHT)
Global $Label16 = GUICtrlCreateLabel("Start Height", 182, 250, 63, 17, $SS_RIGHT)
Global $Label17 = GUICtrlCreateLabel("End Height", 182, 274, 63, 17, $SS_RIGHT)
Global $Label18 = GUICtrlCreateLabel("Rand W/H", 182, 298, 63, 17, $SS_RIGHT)
Global $Button_Sprite_Reset = GUICtrlCreateButton("Reset", 162, 460, 77, 25)
GUICtrlSetTip(-1, "Return all input boxes to default pistol sfx")
GUICtrlSetOnEvent(-1, "Button_Sprite_ResetClick")
Global $Button_Sprite_Import = GUICtrlCreateButton("Import .qdt", 162, 404, 77, 25)
GUICtrlSetOnEvent(-1, "Button_Sprite_ImportClick")
Global $Button_Sprite_Export = GUICtrlCreateButton("Export .qdt", 162, 432, 77, 25)
GUICtrlSetOnEvent(-1, "Button_Sprite_ExportClick")
Global $Label19 = GUICtrlCreateLabel("Vert/Tri Index #", 166, 326, 79, 17, $SS_RIGHT)
Global $Input16_vertexID = GUICtrlCreateInput("0", 250, 324, 62, 21, BitOR($GUI_SS_DEFAULT_INPUT,$ES_NUMBER))
Global $Updown16_vertIndex = GUICtrlCreateUpdown($Input16_vertexID)
GUICtrlSetLimit(-1, 2047, 0)
GUICtrlSetTip(-1, "What vertex/face index do you want the sprite to be attached to. (type=integer)")
Global $Group4 = GUICtrlCreateGroup("Show on frame/s (0-Based)", 322, 196, 149, 291)
Global $Input_f_end_2 = GUICtrlCreateInput("0", 402, 262, 62, 21, BitOR($GUI_SS_DEFAULT_INPUT,$ES_NUMBER))
Global $Updown_f_end_2 = GUICtrlCreateUpdown($Input_f_end_2)
GUICtrlSetLimit(-1, 511, -1)
GUICtrlSetTip(-1, "Integer")
Global $Input_f_start_1 = GUICtrlCreateInput("0", 330, 238, 62, 21, BitOR($GUI_SS_DEFAULT_INPUT,$ES_NUMBER))
Global $Updown_f_start_1 = GUICtrlCreateUpdown($Input_f_start_1)
GUICtrlSetLimit(-1, 511, -1)
GUICtrlSetTip(-1, "Integer")
Global $Input_f_end_1 = GUICtrlCreateInput("0", 402, 238, 63, 21, BitOR($GUI_SS_DEFAULT_INPUT,$ES_NUMBER))
Global $Updown_f_end_1 = GUICtrlCreateUpdown($Input_f_end_1)
GUICtrlSetLimit(-1, 511, -1)
GUICtrlSetTip(-1, "Integer")
Global $Input_f_start_2 = GUICtrlCreateInput("0", 330, 262, 62, 21, BitOR($GUI_SS_DEFAULT_INPUT,$ES_NUMBER))
Global $Updown_f_start_2 = GUICtrlCreateUpdown($Input_f_start_2)
GUICtrlSetLimit(-1, 511, -1)
GUICtrlSetTip(-1, "Integer")
Global $Input_f_start_3 = GUICtrlCreateInput("0", 330, 286, 62, 21, BitOR($GUI_SS_DEFAULT_INPUT,$ES_NUMBER))
Global $Updown_f_start_3 = GUICtrlCreateUpdown($Input_f_start_3)
GUICtrlSetLimit(-1, 511, -1)
GUICtrlSetTip(-1, "Integer")
Global $Input_f_end_3 = GUICtrlCreateInput("0", 402, 286, 62, 21, BitOR($GUI_SS_DEFAULT_INPUT,$ES_NUMBER))
Global $Updown_f_end_3 = GUICtrlCreateUpdown($Input_f_end_3)
GUICtrlSetLimit(-1, 511, -1)
GUICtrlSetTip(-1, "Integer")
Global $Input_f_start_4 = GUICtrlCreateInput("0", 330, 310, 62, 21, BitOR($GUI_SS_DEFAULT_INPUT,$ES_NUMBER))
Global $Updown_f_start_4 = GUICtrlCreateUpdown($Input_f_start_4)
GUICtrlSetLimit(-1, 511, -1)
GUICtrlSetTip(-1, "Integer")
Global $Input_f_end_4 = GUICtrlCreateInput("0", 402, 310, 62, 21, BitOR($GUI_SS_DEFAULT_INPUT,$ES_NUMBER))
Global $Updown_f_end_4 = GUICtrlCreateUpdown($Input_f_end_4)
GUICtrlSetLimit(-1, 511, -1)
GUICtrlSetTip(-1, "Integer")
Global $Input_f_start_5 = GUICtrlCreateInput("0", 330, 334, 62, 21, BitOR($GUI_SS_DEFAULT_INPUT,$ES_NUMBER))
Global $Updown_f_start_5 = GUICtrlCreateUpdown($Input_f_start_5)
GUICtrlSetLimit(-1, 511, -1)
GUICtrlSetTip(-1, "Integer")
Global $Input_f_end_5 = GUICtrlCreateInput("0", 402, 334, 62, 21, BitOR($GUI_SS_DEFAULT_INPUT,$ES_NUMBER))
Global $Updown_f_end_5 = GUICtrlCreateUpdown($Input_f_end_5)
GUICtrlSetLimit(-1, 511, -1)
GUICtrlSetTip(-1, "Integer")
Global $Label21 = GUICtrlCreateLabel("Start", 332, 218, 43, 17)
Global $Label22 = GUICtrlCreateLabel("End", 404, 218, 35, 17)
Global $Input_f_start_6 = GUICtrlCreateInput("0", 330, 358, 62, 21, BitOR($GUI_SS_DEFAULT_INPUT,$ES_NUMBER))
Global $Updown_f_start_6 = GUICtrlCreateUpdown($Input_f_start_6)
GUICtrlSetLimit(-1, 511, -1)
GUICtrlSetTip(-1, "Integer")
Global $Input_f_start_7 = GUICtrlCreateInput("0", 330, 382, 62, 21, BitOR($GUI_SS_DEFAULT_INPUT,$ES_NUMBER))
Global $Updown_f_start_7 = GUICtrlCreateUpdown($Input_f_start_7)
GUICtrlSetLimit(-1, 511, -1)
GUICtrlSetTip(-1, "Integer")
Global $Input_f_start_8 = GUICtrlCreateInput("0", 330, 406, 62, 21, BitOR($GUI_SS_DEFAULT_INPUT,$ES_NUMBER))
Global $Updown_f_start_8 = GUICtrlCreateUpdown($Input_f_start_8)
GUICtrlSetLimit(-1, 511, -1)
GUICtrlSetTip(-1, "Integer")
Global $Input_f_start_9 = GUICtrlCreateInput("0", 330, 430, 62, 21, BitOR($GUI_SS_DEFAULT_INPUT,$ES_NUMBER))
Global $Updown_f_start_9 = GUICtrlCreateUpdown($Input_f_start_9)
GUICtrlSetLimit(-1, 511, -1)
GUICtrlSetTip(-1, "Integer")
Global $Input_f_start_10 = GUICtrlCreateInput("0", 330, 454, 62, 21, BitOR($GUI_SS_DEFAULT_INPUT,$ES_NUMBER))
Global $Updown_f_start_10 = GUICtrlCreateUpdown($Input_f_start_10)
GUICtrlSetLimit(-1, 511, -1)
GUICtrlSetTip(-1, "Integer")
Global $Input_f_end_6 = GUICtrlCreateInput("0", 402, 358, 62, 21, BitOR($GUI_SS_DEFAULT_INPUT,$ES_NUMBER))
Global $Updown_f_end_6 = GUICtrlCreateUpdown($Input_f_end_6)
GUICtrlSetLimit(-1, 511, -1)
GUICtrlSetTip(-1, "Integer")
Global $Input_f_end_7 = GUICtrlCreateInput("0", 402, 382, 62, 21, BitOR($GUI_SS_DEFAULT_INPUT,$ES_NUMBER))
Global $Updown_f_end_7 = GUICtrlCreateUpdown($Input_f_end_7)
GUICtrlSetLimit(-1, 511, -1)
GUICtrlSetTip(-1, "Integer")
Global $Input_f_end_8 = GUICtrlCreateInput("0", 402, 406, 62, 21, BitOR($GUI_SS_DEFAULT_INPUT,$ES_NUMBER))
Global $Updown_f_end_8 = GUICtrlCreateUpdown($Input_f_end_8)
GUICtrlSetLimit(-1, 511, -1)
GUICtrlSetTip(-1, "Integer")
Global $Input_f_end_9 = GUICtrlCreateInput("0", 402, 430, 62, 21, BitOR($GUI_SS_DEFAULT_INPUT,$ES_NUMBER))
Global $Updown_f_end_9 = GUICtrlCreateUpdown($Input_f_end_9)
GUICtrlSetLimit(-1, 511, -1)
GUICtrlSetTip(-1, "Integer")
Global $Input_f_end_10 = GUICtrlCreateInput("0", 402, 454, 62, 21, BitOR($GUI_SS_DEFAULT_INPUT,$ES_NUMBER))
Global $Updown_f_end_10 = GUICtrlCreateUpdown($Input_f_end_10)
GUICtrlSetLimit(-1, 511, -1)
GUICtrlSetTip(-1, "Integer")
GUICtrlCreateGroup("", -99, -99, 1, 1)
Global $Checkbox2 = GUICtrlCreateCheckbox("Add / Update SFX", 246, 404, 69, 81, BitOR($BS_CHECKBOX,$BS_CENTER,$BS_PUSHLIKE,$BS_MULTILINE))
GUICtrlSetFont(-1, 8, 800, 0, "MS Sans Serif")
GUICtrlSetTip(-1, "Add an SFX entry into the .mdx."&@crlf&"Once SFX is inside an mdx it wont be removed."&@crlf&"To disable set all start/end to -1.")
GUICtrlSetOnEvent(-1, "Checkbox2Click")
Global $Button_flags = GUICtrlCreateButton("Flags", 44, 222, 41, 25)
GUICtrlSetOnEvent(-1, "Button_flagsClick")
Global $Combo3_vertTri = GUICtrlCreateCombo("", 250, 372, 63, 25, BitOR($CBS_DROPDOWNLIST,$CBS_AUTOHSCROLL))
GUICtrlSetData(-1, "0: Spawn at Vertex|1: Spawn centre of Triangle", "0: Spawn at Vertex")
GUICtrlSetTip(-1, "Select vertex or triangle to spawn sprite at")
Global $Input2_defineIndex = GUICtrlCreateInput("0", 250, 348, 61, 21, BitOR($GUI_SS_DEFAULT_INPUT,$ES_READONLY,$ES_NUMBER))
GUICtrlSetState(-1, $GUI_DISABLE)
GUICtrlSetTip(-1, "Always use the first defined index.")
Global $Label20 = GUICtrlCreateLabel("Define Index", 182, 350, 63, 17, $SS_RIGHT)
Global $Label23 = GUICtrlCreateLabel("Vert/Tri ?", 182, 374, 63, 17, $SS_RIGHT)
Global $Icon_spr = GUICtrlCreateLabel("", 156, 200, 32, 32, $SS_SUNKEN)
GUICtrlCreateGroup("", -99, -99, 1, 1)
Global $TabScale = GUICtrlCreateTabItem("Scale")
Global $Group7 = GUICtrlCreateGroup("Model Scale/Position", 14, 172, 465, 323)
Global $CheckboxScale = GUICtrlCreateCheckbox("Enable Rescale", 28, 196, 113, 17)
GUICtrlSetOnEvent(-1, "CheckboxScaleClick")
Global $Label3 = GUICtrlCreateLabel("BBox Max XYZ", 22, 224, 81, 17, $SS_RIGHT)
Global $InputScale_1 = GUICtrlCreateInput("0.0", 110, 220, 117, 21)
GUICtrlSetTip(-1, "X")
Global $InputScale_2 = GUICtrlCreateInput("0.0", 230, 220, 117, 21)
GUICtrlSetTip(-1, "Y")
Global $InputScale_3 = GUICtrlCreateInput("0.0", 350, 220, 117, 21)
GUICtrlSetTip(-1, "Z")
Global $Label24 = GUICtrlCreateLabel("BBox Min XYZ", 22, 252, 81, 17, $SS_RIGHT)
Global $InputScale_4 = GUICtrlCreateInput("0.0", 110, 248, 117, 21)
GUICtrlSetTip(-1, "X")
Global $InputScale_5 = GUICtrlCreateInput("0.0", 230, 248, 117, 21)
GUICtrlSetTip(-1, "Y")
Global $InputScale_6 = GUICtrlCreateInput("0.0", 350, 248, 117, 21)
GUICtrlSetTip(-1, "Z")
Global $Edit1 = GUICtrlCreateEdit("", 26, 284, 441, 201, BitOR($ES_AUTOVSCROLL,$ES_AUTOHSCROLL,$ES_READONLY,$ES_WANTRETURN))
GUICtrlSetData(-1, StringFormat("Scale/reposition models using its bounding-box(BBox) size/position.\r\nThis is non destructive so vertex precision wont be lost.\r\n\r\nOnly effective on the first frame. So its not recommended for animated models.\r\n\r\nBBox Max is the most maximum XYZ position of any vertex.\r\nBBox Min is the most minimum XYZ position of any vertex.\r\n\r\nA pickup item BBox is usually min(-15, -15, -15) max(+15, +15, +15)\r\nIf you want to scale it taller while keeping item on the floor you set max-Z higher.\r\nEg.. min(-15, -15, -15) max(+15, +15, +30)"))
Global $btn_scale_drop = GUICtrlCreateButton("Drop To Floor", 350, 188, 117, 25)
GUICtrlSetTip(-1, "Drop Z height to -15")
GUICtrlSetOnEvent(-1, "btn_scale_dropClick")
Global $btn_scale_centre = GUICtrlCreateButton("Centre Model", 230, 188, 113, 25)
GUICtrlSetTip(-1, "Place model at centre origin")
GUICtrlSetOnEvent(-1, "btn_scale_centreClick")
GUICtrlCreateGroup("", -99, -99, 1, 1)
Global $TabAbout = GUICtrlCreateTabItem("About")
Global $Edit2 = GUICtrlCreateEdit("", 12, 176, 468, 321, BitOR($ES_READONLY,$ES_WANTRETURN,$WS_VSCROLL))
GUICtrlSetData(-1, StringFormat("Created By David Smyth (Hypov8)\r\n===========================\r\n\r\nUsed for changing skins/sprites in md2/mdx files without needing a modelling program.\r\nMDX and MD2 are lossy file formats. Storing vertex position as a single Byte(256 grid units)\r\nSo every time you open and save, you may loose vertex precision.\r\nThis program stops the data loss by just updating skin/sprite values.\r\n\r\nOutput file name is always set when a new model is loaded.\r\nFile will be overwritten by default unless you change the Save File Name.\r\nDo take caution updating the original file. Always have a backup.\r\n\r\nSkin path"&Chr(39)&"s can be manually edited/deleted if needed.\r\n\r\nSkin names are truncated if models/, players/, textures/, kingpin/, Quake2/ is found.\r\n\r\nAdded Texture size option.\r\nKingpin max size is 480 but value seems irrelevant to render quality.\r\nQuake2 UV now resize for software mode.\r\nFile drag and drop supported for all input boxes.\r\nFile [ Open with ] supported.\r\n\r\nUSAGE: \r\n=======\r\n#1. Click [ Import ]. Select your md2/mdx file\r\n#2. Click [ File Name ]. If you want to save as a new file\r\n#3. Change skins/sprites as desired. Skin names can be typed.\r\n#4. Click [ GO! ]. This will make a new/updated model with your skins.\r\n\r\nDISCLAIMER: \r\n===========\r\nCare taken writing program but I do not take any responsibility for loss or damages."))
GUICtrlCreateTabItem("")
Global $btn_clear = GUICtrlCreateButton("Clear Skins", 416, 144, 65, 21)
GUICtrlSetTip(-1, "Clear all skins.")
GUICtrlSetOnEvent(-1, "btn_clearClick")
Global $in_size_w = GUICtrlCreateInput("", 336, 144, 37, 21, BitOR($GUI_SS_DEFAULT_INPUT,$ES_NUMBER))
GUICtrlSetLimit(-1, 3)
GUICtrlSetTip(-1, "Texture Width")
Global $in_size_h = GUICtrlCreateInput("", 376, 144, 37, 21, BitOR($GUI_SS_DEFAULT_INPUT,$ES_NUMBER))
GUICtrlSetLimit(-1, 3)
GUICtrlSetTip(-1, "Texture Height")
Global $Label1 = GUICtrlCreateLabel("W/H", 304, 146, 28, 17, $SS_RIGHT)
GUICtrlSetTip(-1, "Skin Width/Height")
GUICtrlCreateGroup("", -99, -99, 1, 1)
Global $Group2 = GUICtrlCreateGroup("#4. Save", 392, 4, 97, 117)
Global $btn_export_GO = GUICtrlCreateButton("GO!", 401, 56, 77, 57)
GUICtrlSetTip(-1, "Generate model"&@CRLF&"CAUTION: make sure you have a backup.")
GUICtrlSetOnEvent(-1, "btn_export_GOClick")
Global $Checkbox1 = GUICtrlCreateCheckbox("Backup", 404, 28, 69, 17)
GUICtrlSetState(-1, $GUI_CHECKED)
GUICtrlSetTip(-1, "Create a backup file (file_name.mdx.backup)"&@CRLF&"File will NOT be backed up if a backup already exists")
GUICtrlCreateGroup("", -99, -99, 1, 1)
GUISetState(@SW_SHOW)
#EndRegion ### END Koda GUI section ###



#Region ### START Koda GUI section ### Form=c:\programs\codeing\autoit-v3\scite\koda\dave\kp\model_fix_popup_flags.kxf
Global $DMFLAGS = GUICreate("SFX FLAGS", 486, 500, -1, -1, $WS_POPUP, -1, $KPModelSkins)
GUISetOnEvent($GUI_EVENT_CLOSE, "DMFLAGSClose")
Global $Group1_flags = GUICtrlCreateGroup("Sprite Flags", 12, 40, 457, 449)
Global $box_flags_1 = GUICtrlCreateCheckbox("1 = Add Gravity", 20, 64, 205, 17)
Global $box_flags_2 = GUICtrlCreateCheckbox("2 = Fixed Decal", 20, 88, 205, 17)
Global $box_flags_4 = GUICtrlCreateCheckbox("4 = No Random Rotation", 20, 112, 205, 17)
Global $box_flags_8 = GUICtrlCreateCheckbox("8 = Fixed Decal. Sort Near. Blend Blue", 20, 136, 205, 17)
Global $box_flags_16 = GUICtrlCreateCheckbox("16 = Sort Near. Alpha", 20, 160, 205, 17)
Global $box_flags_32 = GUICtrlCreateCheckbox("32 = 2D Sprite (Rotate Z)", 20, 184, 205, 17)
Global $box_flags_64 = GUICtrlCreateCheckbox("64 = Move up. Black", 20, 208, 205, 17)
Global $box_flags_128 = GUICtrlCreateCheckbox("128 = Blend White", 20, 232, 205, 17)
Global $box_flags_256 = GUICtrlCreateCheckbox("256 = Sprite (Alpha)", 20, 256, 205, 17)
Global $box_flags_512 = GUICtrlCreateCheckbox("512 = Blend Blue", 20, 280, 205, 17)
Global $box_flags_1024 = GUICtrlCreateCheckbox("1024 = Cull Close", 20, 304, 205, 17)
Global $Button_flags_Close = GUICtrlCreateButton("Close", 84, 356, 309, 109)
GUICtrlSetOnEvent(-1, "DMFLAGSClose")
Global $Label1 = GUICtrlCreateLabel("SFX_FLAG_GRAVITY", 236, 64, 164, 17)
Global $Label2 = GUICtrlCreateLabel("SFX_FLAG_SURFACE_EFFECT", 236, 88, 164, 17)
Global $Label3 = GUICtrlCreateLabel("SFX_FLAG_NO_FLIP", 236, 112, 164, 17)
Global $Label4 = GUICtrlCreateLabel("SFX_FLAG_LIGHTFLARE", 236, 136, 164, 17)
Global $Label5 = GUICtrlCreateLabel("SFX_FLAG_DEPTHHACK", 236, 160, 164, 17)
Global $Label6 = GUICtrlCreateLabel("SFX_FLAG_UPRIGHT", 236, 184, 164, 17)
Global $Label7 = GUICtrlCreateLabel("SFX_FLAG_VEL_IS_ANGLES", 236, 208, 164, 17)
Global $Label8 = GUICtrlCreateLabel("SFX_FLAG_ADDITIVE_BLEND", 236, 232, 164, 17)
Global $Label9 = GUICtrlCreateLabel("SFX_FLAG_ALPHA_IS_FRAME", 236, 256, 164, 17)
Global $Label10 = GUICtrlCreateLabel("SFX_FLAG_VEL_IS_COLOR_MODULATION", 236, 280, 220, 17)
Global $Label11 = GUICtrlCreateLabel("SFX_FLAG_CLOSE_CULL", 236, 304, 164, 17)
GUICtrlCreateGroup("", -99, -99, 1, 1)
Global $Button_flags_CloseX = GUICtrlCreateButton("X", 440, 8, 25, 25)
GUICtrlSetOnEvent(-1, "DMFLAGSClose")
#EndRegion ### END Koda GUI section ###



#Region ### START Koda GUI section ### Form=C:\Programs\codeing\autoit-v3\SciTe\Koda\Dave\msg_box_form.kxf
;Global $Form1_msgbox = GUICreate("Info", 139, 96, -1, -1, -1, -1, $KPModelSkins)
Global $Form1_msgbox = GUICreate("Info", 145, 118, -1, -1, $WS_SYSMENU, -1, $KPModelSkins)
GUISetOnEvent($GUI_EVENT_CLOSE, "Form1_msgboxClose", $Form1_msgbox)
Global $Button1_msgbox = GUICtrlCreateButton("&OK", 37, 65, 75, 23)
GUICtrlSetOnEvent(-1, "Form1_msgboxClose")
Global $Label1_bakgrn = GUICtrlCreateLabel("", 0, 0, 138, 57)
GUICtrlSetBkColor(-1, 0xFFFFFF)
Global $Label1_msgbox = GUICtrlCreateLabel("Label1_msgbox", 12, 16, 116, 17)
GUICtrlSetBkColor(-1, 0xFFFFFF)
Global $Label2_msgbox = GUICtrlCreateLabel("Label2_msgbox", 12, 32, 116, 17)
GUICtrlSetBkColor(-1, 0xFFFFFF)
#EndRegion ### END Koda GUI section ###



#Region #Global
Global Const $MAXTRIANGLES = 4096
Global Const $MAXVERTEX = 2048
Global Const $iMAXTEXCORDS = $MAXTRIANGLES*3 ;todo: load invalid? or is this ok?
Global Const $iMAXSKIN = 32
Global $skin[$iMAXSKIN+1]
Global Const $iSMDX = 1
Global Const $iSMD2 = 2
Global Const $iSMD3 = 3
Global $importFileName =""
Global $exportFileName =""
Global $modelType = 0
Global $model_DATA_END, $model_DATA_preSFX, $model_DATA_tri, $model_DATA_scale[6], $model_DATA_frame
Global Const $iSFX_DEF_SIZE = (17*4)
Global Const $iSFX_ENTRY_SIZE = (3*4+64)
Global $isActive_msgBox = 0

Global $g_aMD3_surf[$iMAXSKIN+1][2]
Global $g_iMD3_tex = 0


Global $hdr_MD3_path,$hdr_MD3_flags,$hdr_MD3_frames,$hdr_MD3_numTags,$hdr_MD3_numSurf,$hdr_MD3_numSkin
Global $hdr_MD3_offFrames,$hdr_MD3_ofsTags,$hdr_MD3_ofsSurf,$hdr_MD3_EOF

;sprites
Global $aSFX_define[17]
Global $aSFX_add[4]
Global $aSFX_add_frames[10]
Global $aFrames[512]		;frames to enable sfx
Global $aFrameRange[10][2] 	;frame input boxes (10)
Global $sFileName = "test" 	;store file name for saving qdt
Global $model_DATA_SFXDef[25]
Global $model_DATA_SFXEntry[25]

;GUI's
GUISetState(@SW_HIDE, $DMFLAGS)
GUISetState(@SW_HIDE, $Form1_msgbox)

;
Global $fileOpenDialogPath = @ScriptDir &"\"

;headder global
Global $hdr_magic,$hdr_version,$hdr_skinWidth,$hdr_skinHeight,$hdr_frameSize,$hdr_numSkins,$hdr_numVertices
;headder mdx
Global $hdr_numTriangles, $hdr_numGlCommands, $hdr_numFrames, $hdr_numSfxDefines, $hdr_numSfxEntries,  $hdr_numSubObjects, $hdr_offsetSkins, $hdr_offsetTriangles, $hdr_offsetFrames, _
		$hdr_offsetGlCommands, 	$hdr_offsetVertexInfo, $hdr_offsetSfxDefines, $hdr_offsetSfxEntries, $hdr_offsetBBoxFrames, $hdr_offsetDummyEnd, $hdr_offsetEnd
;headder md2
Global $hdr_numTexCoords, $hdr_numTriangles, $hdr_numGlCommands, $hdr_numFrames, $hdr_offsetSkins, $hdr_offsetTexCoords, $hdr_offsetTriangles, $hdr_offsetFrames, $hdr_offsetGlCommands, $hdr_offsetEnd
Global 	$hdr_offsetBBoxFrames_size,	$hdr_offsetDummyEnd_size, $hdr_offsetEnd_size,	$hdr_offsetTriangles_size,$hdr_offsetFrames_size, _
		$hdr_offsetGlCommands_size,$hdr_offsetVertexInfo_size, $hdr_offsetTexCoords_size, $hdr_offsetSkins_size

Global $hdr_TexCoords[$iMAXTEXCORDS][2] ;max verts, x/y

;SFX Type conversion array
Global Const $aSFX_Type[49] = [ _
	0, _ ;0: Blood (Called SFX_SPRITE_SURF_BLOOD1 in code)|"
	1, _ ;1: Bullet Hole (Called SFX_SPRITE_SURF_BULLET1 in code)|"
	2, _ ;2: Riple (Called SFX_SPRITE_SURF_RIPPLE in code)|"
	5, _ ;3: Blood Pool (Called SFX_SPRITE_SURF_BLOOD_POOL in code)|"
	6, _ ;4: Blood Splat|"
	7, _ ;5: Blood Drop|"
	8, _ ;6: Smoke Small|"
	9, _ ;7: Fire|"
	10, _ ;8: Carona|"
	16, _ ;9: Same as 9:|"
	17, _ ;10: Carona Amber|"
	18, _ ;11: Carona Red|"
	19, _ ;12: Carona Green|"
	20, _ ;13: Carona Blue|"
	21, _ ;14: Rain|"
	22, _ ;15: Smoke Small R (Red? but is not red. unfisched texture)|"
	23, _ ;16: Sniper 1c (Missing texture)|"
	24, _ ;17: Sniper 2 (Missing texture)"
	25, _ ;18: Same as 2."
	71, _ ;19: Blood 1"
	72, _ ;20: Blood 1b"
	73, _ ;21: Blood 1c"
	74, _ ;22: Blood 1d"
	75, _ ;23: Blood 1e"
	76, _ ;24: Blood 1f"
	77, _ ;25: Blood 1g"
	78, _ ;26: Blood 1h"
	79, _ ;27: Blood 1i"
	80, _ ;28: Muzzle flash 3"
	100, _ ;29: Muzzle flash HMG (Used for HMG)"
	101, _ ;30: Muzzle flash 1 (Used for Pistol)"
	102, _ ;31: Muzzle flash 2"
	103, _ ;32: Same as 80."
	104, _ ;33: Muzzle flash 4"
	106, _ ;34: Muzzle flash 1a"
	107, _ ;35: Muzzle flash 2a"
	108, _ ;36: Muzzle flash 2b"
	110, _ ;37: Explode 1"
	111, _ ;38: Explode 2"
	116, _ ;39: Smoke Animated"
	120, _ ;40: Flame Thrower"
	121, _ ;41: Return error texture."
	122, _ ;42: Flame Thrower Blue"
	123, _ ;43: Same as 121."
	124, _ ;44: Splash 1"
	125, _ ;45: Splash 2"
	126, _ ;46: Splash 3"
	127, _ ;47: Splash 4"
	128]   ;48: Firewall", "101: Muzzle flash 1 (Used for Pistol)")"


GUICtrlSetState($in_model_import, $GUI_DROPACCEPTED)
GUICtrlSetState($btn_import, $GUI_DROPACCEPTED)
GUICtrlSetState($Group1, $GUI_DROPACCEPTED)

GUICtrlSetState($in_model_export, $GUI_DROPACCEPTED)
; GUICtrlSetState($btn_export_file, $GUI_DROPACCEPTED)
GUICtrlSetState($Group3, $GUI_DROPACCEPTED)

GUICtrlSetState($in_skin_1, $GUI_DROPACCEPTED)
GUICtrlSetState($in_skin_2, $GUI_DROPACCEPTED)
GUICtrlSetState($in_skin_3, $GUI_DROPACCEPTED)
GUICtrlSetState($in_skin_4, $GUI_DROPACCEPTED)
GUICtrlSetState($in_skin_5, $GUI_DROPACCEPTED)
GUICtrlSetState($in_skin_6, $GUI_DROPACCEPTED)
GUICtrlSetState($in_skin_7, $GUI_DROPACCEPTED)
GUICtrlSetState($in_skin_8, $GUI_DROPACCEPTED)
GUICtrlSetState($in_skin_9, $GUI_DROPACCEPTED)
GUICtrlSetState($in_skin_10, $GUI_DROPACCEPTED)
GUICtrlSetState($in_skin_11, $GUI_DROPACCEPTED)
GUICtrlSetState($in_skin_12, $GUI_DROPACCEPTED)
GUICtrlSetState($in_skin_13, $GUI_DROPACCEPTED)
GUICtrlSetState($in_skin_14, $GUI_DROPACCEPTED)
GUICtrlSetState($in_skin_15, $GUI_DROPACCEPTED)
GUICtrlSetState($in_skin_16, $GUI_DROPACCEPTED)
GUICtrlSetState($in_skin_17, $GUI_DROPACCEPTED)
GUICtrlSetState($in_skin_18, $GUI_DROPACCEPTED)
GUICtrlSetState($in_skin_19, $GUI_DROPACCEPTED)
GUICtrlSetState($in_skin_20, $GUI_DROPACCEPTED)
GUICtrlSetState($in_skin_21, $GUI_DROPACCEPTED)
GUICtrlSetState($in_skin_22, $GUI_DROPACCEPTED)
GUICtrlSetState($in_skin_23, $GUI_DROPACCEPTED)
GUICtrlSetState($in_skin_24, $GUI_DROPACCEPTED)
GUICtrlSetState($in_skin_25, $GUI_DROPACCEPTED)
GUICtrlSetState($in_skin_26, $GUI_DROPACCEPTED)
GUICtrlSetState($in_skin_27, $GUI_DROPACCEPTED)
GUICtrlSetState($in_skin_28, $GUI_DROPACCEPTED)
GUICtrlSetState($in_skin_29, $GUI_DROPACCEPTED)
GUICtrlSetState($in_skin_30, $GUI_DROPACCEPTED)
GUICtrlSetState($in_skin_31, $GUI_DROPACCEPTED)
GUICtrlSetState($in_skin_32, $GUI_DROPACCEPTED)
GUISetOnEvent($GUI_EVENT_DROPPED, "fn_dropFile",$KPModelSkins)

_GUICtrlComboBox_SetDroppedWidth($Combo1_SFX_Type, 350)
_GUICtrlComboBox_SetDroppedWidth($Combo3_vertTri, 150)
_GUICtrlComboBox_SetDroppedWidth($Combo2_direction, 150)

;~ _ResourceSetImageToCtrl($Button6_up,"btn_up" )
;~ _ResourceSetImageToCtrl($Button6_down,"btn_dn")
;~ _ResourceSetImageToCtrl($Label6_up,"btn_up_")
;~ _ResourceSetImageToCtrl($Label6_dn,"btn_dn_")

#EndRegion


#Region ;==> GUI util
; Startup input filename
if $CmdLine[0] >= 1 Then
	if $CmdLine[1] <> "" Then
		If StringInStr($CmdLine[1], ".mdx") Or StringInStr($CmdLine[1], ".md2") Then
			fn_ImportModel($CmdLine[1])
		EndIf
	EndIf
EndIf

; set the folder for open/save dialog boxes
Func fn_dropFileSkins($filePath)
	$fileOpenDialogPath = $filePath
	;ConsoleWrite("!set openFile Dialog drop skin= "&$fileOpenDialogPath&@CRLF)
	return fn_TrimFilePath($filePath)
EndFunc


; drop files onto GUI
Func fn_dropFile()
	Switch @GUI_DropId
		Case $Group1 ;$in_model_import, , $btn_import
			fn_ImportModel(@GUI_DragFile)	;GUICtrlSetData($in_model_import,@GUI_DragFile)
		Case $Group3 ;$in_model_export, ,$btn_export_file
			$exportFileName = @GUI_DragFile
			GUICtrlSetData($in_model_export, @GUI_DragFile)

		Case $in_skin_1
			GUICtrlSetData($in_skin_1, fn_dropFileSkins(@GUI_DragFile))
		Case $in_skin_2
			GUICtrlSetData($in_skin_2, fn_dropFileSkins(@GUI_DragFile))
		Case $in_skin_3
			GUICtrlSetData($in_skin_3, fn_dropFileSkins(@GUI_DragFile))
		Case $in_skin_4
			GUICtrlSetData($in_skin_4, fn_dropFileSkins(@GUI_DragFile))
		Case $in_skin_5
			GUICtrlSetData($in_skin_5, fn_dropFileSkins(@GUI_DragFile))
		Case $in_skin_6
			GUICtrlSetData($in_skin_6, fn_dropFileSkins(@GUI_DragFile))
		Case $in_skin_7
			GUICtrlSetData($in_skin_7, fn_dropFileSkins(@GUI_DragFile))
		Case $in_skin_8
			GUICtrlSetData($in_skin_8, fn_dropFileSkins(@GUI_DragFile))
		Case $in_skin_9
			GUICtrlSetData($in_skin_9, fn_dropFileSkins(@GUI_DragFile))
		Case $in_skin_10
			GUICtrlSetData($in_skin_10, fn_dropFileSkins(@GUI_DragFile))
		Case $in_skin_11
			GUICtrlSetData($in_skin_11, fn_dropFileSkins(@GUI_DragFile))
		Case $in_skin_12
			GUICtrlSetData($in_skin_12, fn_dropFileSkins(@GUI_DragFile))
		Case $in_skin_13
			GUICtrlSetData($in_skin_13, fn_dropFileSkins(@GUI_DragFile))
		Case $in_skin_14
			GUICtrlSetData($in_skin_14, fn_dropFileSkins(@GUI_DragFile))
		Case $in_skin_15
			GUICtrlSetData($in_skin_15, fn_dropFileSkins(@GUI_DragFile))
		Case $in_skin_16
			GUICtrlSetData($in_skin_16, fn_dropFileSkins(@GUI_DragFile))
		Case $in_skin_17
			GUICtrlSetData($in_skin_17, fn_dropFileSkins(@GUI_DragFile))
		Case $in_skin_18
			GUICtrlSetData($in_skin_18, fn_dropFileSkins(@GUI_DragFile))
		Case $in_skin_19
			GUICtrlSetData($in_skin_19, fn_dropFileSkins(@GUI_DragFile))
		Case $in_skin_20
			GUICtrlSetData($in_skin_20, fn_dropFileSkins(@GUI_DragFile))
		Case $in_skin_21
			GUICtrlSetData($in_skin_21, fn_dropFileSkins(@GUI_DragFile))
		Case $in_skin_22
			GUICtrlSetData($in_skin_22, fn_dropFileSkins(@GUI_DragFile))
		Case $in_skin_23
			GUICtrlSetData($in_skin_23, fn_dropFileSkins(@GUI_DragFile))
		Case $in_skin_24
			GUICtrlSetData($in_skin_24, fn_dropFileSkins(@GUI_DragFile))
		Case $in_skin_25
			GUICtrlSetData($in_skin_25, fn_dropFileSkins(@GUI_DragFile))
		Case $in_skin_26
			GUICtrlSetData($in_skin_26, fn_dropFileSkins(@GUI_DragFile))
		Case $in_skin_27
			GUICtrlSetData($in_skin_27, fn_dropFileSkins(@GUI_DragFile))
		Case $in_skin_28
			GUICtrlSetData($in_skin_28, fn_dropFileSkins(@GUI_DragFile))
		Case $in_skin_29
			GUICtrlSetData($in_skin_29, fn_dropFileSkins(@GUI_DragFile))
		Case $in_skin_30
			GUICtrlSetData($in_skin_30, fn_dropFileSkins(@GUI_DragFile))
		Case $in_skin_31
			GUICtrlSetData($in_skin_31, fn_dropFileSkins(@GUI_DragFile))
		Case $in_skin_32
			GUICtrlSetData($in_skin_32, fn_dropFileSkins(@GUI_DragFile))
	EndSwitch
EndFunc

Func _IsChecked($idControlID)
	Return BitAND(GUICtrlRead($idControlID), $GUI_CHECKED) = $GUI_CHECKED
EndFunc

Func KPModelSkinsClose()
	fn_ResetSFX_arrays()
	fn_ResetSFX_DATA()
	GUIDelete($KPModelSkins)
	GUIDelete($Form1_msgbox)
	GUIDelete($DMFLAGS)
	Exit
EndFunc

Func fn_Swap4Bytes($4bytes)
	local $a1 = StringSplit($4bytes,"", 1)
	local $sResult=""
	If $a1[0] = 8 Then
		$sResult =$a1[7]&$a1[8] & $a1[5]&$a1[6] & $a1[3]&$a1[4] & $a1[1]&$a1[2]
	ElseIf $a1[0] = 4 Then
		$sResult = $a1[3]&$a1[4] & $a1[1]&$a1[2]
	;ElseIf $a1[0] = 2 Then
	;	$sResult = $a1[2]&$a1[1]
	Else
		$sResult = $4bytes
		ConsoleWrite ("!!ERROR: Swap4Bytes= "&$4bytes&@CRLF)
	EndIf
	;ConsoleWrite ("in= "&$4bytes & "out= " &$sResult&@CRLF)

	Return $sResult
EndFunc ;==> end fn_Swap4Bytes

Func fn_StripNullFromString($sString)
	Local $iIdx = StringInStr($sString, Chr(0))
	If $iIdx Then
		Return  StringLeft($sString, $iIdx-1)
	EndIf

	Return $sString ;unchanged
EndFunc

Func fn_SetCurrentFolder($filePath)
	Local $iIdx = StringInStr($filePath, "\",1, -1)
	If $iIdx Then
		$fileOpenDialogPath = StringLeft($filePath, $iIdx)
		ConsoleWrite("!set openFile Dialog= "&$fileOpenDialogPath&@CRLF)
	EndIf
EndFunc

Func btn_importClick()
	local $fileName = FileOpenDialog("Kingpin Model", $fileOpenDialogPath, "Kingpin Models (*.md2;*.mdx)",1 ,"", $KPModelSkins)
	If not @error Then
		fn_ImportModel($fileName)
	EndIf
EndFunc

Func fn_ImportModel($fileName)
	$importFileName =""
	$exportFileName =""

	if FileExists($fileName) Then
		GUICtrlSetData($in_model_import, $fileName)
		GUICtrlSetData($in_model_export, $fileName)
		$importFileName = $fileName
		$exportFileName = $fileName
		fn_SetCurrentFolder($fileName); set recent folder
		GUICtrlSetState($Checkbox2,$GUI_UNCHECKED);set SFX buton to default OFF

		Local $bFile = 			FileOpen ( $fileName , 16) ;$FO_UTF16_LE ) ;binary mode
		$hdr_magic = 			hex(FileRead($bFile, 4))
		$hdr_version = 			_WinAPI_SwapDWord(dec(hex(FileRead($bFile, 4), 8)))
		ConsoleWrite("--> header_magic = " & _HexToString($hdr_magic)&@CRLF)
		ConsoleWrite("--> header_magic = " & $hdr_magic&@CRLF)
		ConsoleWrite("--> $hdr_version = " & $hdr_version&@CRLF)

		if $hdr_magic == "49445058" And $hdr_version = 4 Then ;IDPX
			$modelType = $iSMDX
			$hdr_skinWidth = 		_WinAPI_SwapDWord(dec(hex(FileRead($bFile, 4), 8)))
			$hdr_skinHeight = 		_WinAPI_SwapDWord(dec(hex(FileRead($bFile, 4), 8)))
			$hdr_frameSize = 		_WinAPI_SwapDWord(dec(hex(FileRead($bFile, 4), 8)))
			$hdr_numSkins = 		_WinAPI_SwapDWord(dec(hex(FileRead($bFile, 4), 8)))
			$hdr_numVertices = 		_WinAPI_SwapDWord(dec(hex(FileRead($bFile, 4), 8)))
			GUICtrlSetData($in_size_w, $hdr_skinWidth);set GUI skin size
			GUICtrlSetData($in_size_h, $hdr_skinHeight);set GUI skin size
			;
			$hdr_numTriangles = 		_WinAPI_SwapDWord(dec(hex(FileRead($bFile, 4), 8)))
			$hdr_numGlCommands = 		_WinAPI_SwapDWord(dec(hex(FileRead($bFile, 4), 8)))
			$hdr_numFrames = 			_WinAPI_SwapDWord(dec(hex(FileRead($bFile, 4), 8)))
			$hdr_numSfxDefines = 		_WinAPI_SwapDWord(dec(hex(FileRead($bFile, 4), 8)))
			$hdr_numSfxEntries = 		_WinAPI_SwapDWord(dec(hex(FileRead($bFile, 4), 8)))
			$hdr_numSubObjects = 		_WinAPI_SwapDWord(dec(hex(FileRead($bFile, 4), 8)))
			$hdr_offsetSkins = 			_WinAPI_SwapDWord(dec(hex(FileRead($bFile, 4), 8)))
			$hdr_offsetTriangles = 		_WinAPI_SwapDWord(dec(hex(FileRead($bFile, 4), 8)))
			$hdr_offsetFrames = 		_WinAPI_SwapDWord(dec(hex(FileRead($bFile, 4), 8)))
			$hdr_offsetGlCommands = 	_WinAPI_SwapDWord(dec(hex(FileRead($bFile, 4), 8)))
			$hdr_offsetVertexInfo = 	_WinAPI_SwapDWord(dec(hex(FileRead($bFile, 4), 8)))
			$hdr_offsetSfxDefines = 	_WinAPI_SwapDWord(dec(hex(FileRead($bFile, 4), 8)))
			$hdr_offsetSfxEntries = 	_WinAPI_SwapDWord(dec(hex(FileRead($bFile, 4), 8)))
			$hdr_offsetBBoxFrames = 	_WinAPI_SwapDWord(dec(hex(FileRead($bFile, 4), 8)))
			$hdr_offsetDummyEnd = 		_WinAPI_SwapDWord(dec(hex(FileRead($bFile, 4), 8)))
			$hdr_offsetEnd = 			_WinAPI_SwapDWord(dec(hex(FileRead($bFile, 4), 8)))

			; get data size for saving
			$hdr_offsetSkins_size = 23*4
			$hdr_offsetTriangles_size = $hdr_offsetFrames - $hdr_offsetTriangles
			$hdr_offsetFrames_size = $hdr_offsetGlCommands - $hdr_offsetFrames
			$hdr_offsetGlCommands_size = $hdr_offsetVertexInfo - $hdr_offsetGlCommands
			$hdr_offsetVertexInfo_size = $hdr_offsetSfxDefines - $hdr_offsetVertexInfo
			;sfxDef
			;sfxEnt
			$hdr_offsetBBoxFrames_size = 	$hdr_offsetEnd - $hdr_offsetBBoxFrames
			$hdr_offsetDummyEnd_size = 		$hdr_offsetDummyEnd - $hdr_offsetBBoxFrames
			$hdr_offsetEnd_size = 			0
		ElseIf $hdr_magic == "49445032" And $hdr_version = 8 Then ;IDP2
			$modelType = $iSMD2
			$hdr_skinWidth = 		_WinAPI_SwapDWord(dec(hex(FileRead($bFile, 4), 8)))
			$hdr_skinHeight = 		_WinAPI_SwapDWord(dec(hex(FileRead($bFile, 4), 8)))
			$hdr_frameSize = 		_WinAPI_SwapDWord(dec(hex(FileRead($bFile, 4), 8)))
			$hdr_numSkins = 		_WinAPI_SwapDWord(dec(hex(FileRead($bFile, 4), 8)))
			$hdr_numVertices = 		_WinAPI_SwapDWord(dec(hex(FileRead($bFile, 4), 8)))
			GUICtrlSetData($in_size_w, $hdr_skinWidth);set GUI skin size
			GUICtrlSetData($in_size_h, $hdr_skinHeight);set GUI skin size
			$hdr_numTexCoords = 		_WinAPI_SwapDWord(dec(hex(FileRead($bFile, 4), 8)))
			$hdr_numTriangles = 		_WinAPI_SwapDWord(dec(hex(FileRead($bFile, 4), 8)))
			$hdr_numGlCommands = 		_WinAPI_SwapDWord(dec(hex(FileRead($bFile, 4), 8)))
			$hdr_numFrames = 			_WinAPI_SwapDWord(dec(hex(FileRead($bFile, 4), 8)))
			$hdr_offsetSkins = 			_WinAPI_SwapDWord(dec(hex(FileRead($bFile, 4), 8)))
			$hdr_offsetTexCoords = 		_WinAPI_SwapDWord(dec(hex(FileRead($bFile, 4), 8)))
			$hdr_offsetTriangles = 		_WinAPI_SwapDWord(dec(hex(FileRead($bFile, 4), 8)))
			$hdr_offsetFrames = 		_WinAPI_SwapDWord(dec(hex(FileRead($bFile, 4), 8)))
			$hdr_offsetGlCommands = 	_WinAPI_SwapDWord(dec(hex(FileRead($bFile, 4), 8)))
			$hdr_offsetEnd = 			_WinAPI_SwapDWord(dec(hex(FileRead($bFile, 4), 8)))

			; get data size for saving
			$hdr_offsetSkins_size = 17*4
			$hdr_offsetTexCoords_size = 	$hdr_offsetTriangles - $hdr_offsetTexCoords
			$hdr_offsetTriangles_size = 	$hdr_offsetFrames - $hdr_offsetTriangles
			$hdr_offsetFrames_size = 		$hdr_offsetGlCommands - $hdr_offsetFrames
			$hdr_offsetGlCommands_size = 	$hdr_offsetEnd - $hdr_offsetGlCommands
			$hdr_offsetEnd_size = 			0

		;;;;;;;;;;;; MD3 ;;;;;;;;;;;;;;;;;;
		ElseIf $hdr_magic == "49445033" And $hdr_version = 15 Then ;IDP3
			ConsoleWrite("found MD3" &@CRLF)
			$modelType = $iSMD3
			$hdr_MD3_path =			_HexToString(FileRead($bFile, 64)) ;todo: file path
			$hdr_MD3_flags = 		_WinAPI_SwapDWord(dec(hex(FileRead($bFile, 4), 8))) ;flags
			$hdr_MD3_frames = 		_WinAPI_SwapDWord(dec(hex(FileRead($bFile, 4), 8))) ;num frames
			$hdr_MD3_numTags = 		_WinAPI_SwapDWord(dec(hex(FileRead($bFile, 4), 8))) ;num tags
			$hdr_MD3_numSurf =		_WinAPI_SwapDWord(dec(hex(FileRead($bFile, 4), 8))) ;NUM_SURFACES
			$hdr_MD3_numSkin = 		_WinAPI_SwapDWord(dec(hex(FileRead($bFile, 4), 8)))	;NUM_SKINS
			;offsets
			$hdr_MD3_offFrames = _WinAPI_SwapDWord(dec(hex(FileRead($bFile, 4), 8)));OFS_FRAMES
			$hdr_MD3_ofsTags = 	_WinAPI_SwapDWord(dec(hex(FileRead($bFile, 4), 8)));OFS_TAGS
			$hdr_MD3_ofsSurf = 	_WinAPI_SwapDWord(dec(hex(FileRead($bFile, 4), 8)));OFS_SURFACES
			$hdr_MD3_EOF = 		_WinAPI_SwapDWord(dec(hex(FileRead($bFile, 4), 8)));OFS_EOF
		Else
			$modelType = 0
		EndIf

		If ($modelType = 0) Or  ($hdr_numSkins > $iMAXSKIN) or _
			(($modelType = $iSMD2) And ($hdr_numTexCoords > $iMAXTEXCORDS)) Then
			$modelType = 0
			FileClose ( $bFile )
			fn_MSG_box("File Invalid.")
			Return
		EndIf

		;clear old skins
		fn_ResetSkinInput()

		;clear sprie data
		fn_ResetSFX_arrays()
		fn_ResetSFX_DATA()
		fn_Reset_SpriteTab_Data()
		fn_Reset_Scale()


		;MD3 read skins/shaders
		if $modelType == $iSMD3 Then
			;read md3 surface
			Local $iCurOffset = $hdr_MD3_ofsSurf
			FileSetPos($bFile, $iCurOffset, $FILE_BEGIN)
			;id, name, flag, numFr, numShd, numVer, numTri, ofsTri, ofsShd, ofsST, ofsXYZ, ofsNor, ofsEnd
			$g_iMD3_tex = 0 ;texture index
			ConsoleWrite("current offs=" & $iCurOffset&@CRLF)

			for $i1 = 1 to $hdr_MD3_numSurf ;num surf
				FileSetPos($bFile, 4+64+4+4, $FILE_CURRENT) ; seek to NUM_SHADERS
				Local $iNumShad = _WinAPI_SwapDWord(dec(hex(FileRead($bFile, 4), 8))) ;+76

				FileSetPos($bFile, 12, $FILE_CURRENT) ;seek to OFS_SHADERS
				Local $iOffsShad = _WinAPI_SwapDWord(dec(hex(FileRead($bFile, 4), 8))) ;+12

				FileSetPos($bFile, 8, $FILE_CURRENT) ;seek to OFS_END
				Local $iOffsEnd = _WinAPI_SwapDWord(dec(hex(FileRead($bFile, 4), 8))) ;+4
				FileSetPos($bFile,$iCurOffset + $iOffsShad, $FILE_BEGIN)

				for $i2 = 1 to $iNumShad ;num surf
					$g_iMD3_tex += 1 ;write skins	1-based
					If $g_iMD3_tex <= $iMAXSKIN Then ;max skin count
						$g_aMD3_surf[$g_iMD3_tex][0] = FileGetPos($bFile) ; $iCurOffset + $iOffsShad +( ($i2-1)*68) ;save file offset
						$g_aMD3_surf[$g_iMD3_tex][1] = fn_StripNullFromString(_HexToString(FileRead($bFile, 64)))
						FileSetPos($bFile, 4, $FILE_CURRENT)
					EndIf
				Next
				;move to next object
				$iCurOffset += $iOffsEnd
				ConsoleWrite("current offs=" & $iCurOffset&@CRLF)
				FileSetPos($bFile, $iCurOffset, $FILE_BEGIN) ; seek to SURFACE_START
			Next

			;copt to $skin array
			for $i1 = 1 to $g_iMD3_tex
				$skin[$i1] = $g_aMD3_surf[$i1][1]
			Next

		Else ; md2/mdx
			;read skins
			ConsoleWrite("header_numSkins = " & string($hdr_numSkins) & @CRLF)
			FileSetPos($bFile, $hdr_offsetSkins, $FILE_BEGIN)
			for $i1 = 1 to $hdr_numSkins
				Local $tmpSkin =_HexToString(FileRead($bFile, 64)) ;BinaryToString
				If $i1 <= $iMAXSKIN Then ;max skin count
					$skin[$i1] = fn_StripNullFromString($tmpSkin) ;remove anything after null
					ConsoleWrite('skin '& $i1&'= '&$skin[$i1]&@CRLF)
				EndIf
			Next;==> end skins


			;md2 read text cords
			if ($modelType = $iSMD2) Then
				FileSetPos($bFile, $hdr_offsetTexCoords, $FILE_BEGIN)
				For $i1 = 0 To ($hdr_numTexCoords - 1)
					$hdr_TexCoords[$i1][0] = _WinAPI_SwapWord(dec(hex(FileRead($bFile, 2), 4))) / $hdr_skinWidth;
					$hdr_TexCoords[$i1][1] = _WinAPI_SwapWord(dec(hex(FileRead($bFile, 2), 4))) / $hdr_skinHeight;
				Next
			EndIf ;==> end text cords

			;read triangle data
			FileSetPos($bFile, $hdr_offsetTriangles, $FILE_BEGIN)
			$model_DATA_tri = hex(FileRead($bFile, $hdr_offsetFrames - $hdr_offsetTriangles))

			;read frame data
			FileSetPos($bFile, $hdr_offsetFrames, $FILE_BEGIN)
			For $iI = 0 to 5;read float
				$model_DATA_scale[$iI] = _WinAPI_DWordToFloat(_WinAPI_SwapDWord(dec(hex(FileRead($bFile, 4), 8))))
			Next
			if ($modelType = $iSMDX) Then
				$model_DATA_frame = hex(FileRead($bFile, $hdr_offsetSfxDefines - $hdr_offsetFrames -(4*6)))
			Else
				$model_DATA_frame = hex(FileRead($bFile, $hdr_offsetGlCommands - $hdr_offsetFrames -(4*6)))
			EndIf



			;mdx read sfx
			if ($modelType = $iSMDX) Then
				;FileSetPos($bFile, $hdr_offsetTriangles, $FILE_BEGIN)
				;$model_DATA_preSFX = hex(FileRead($bFile, $hdr_offsetSfxDefines - $hdr_offsetTriangles)) ;todo split?

				if ($hdr_numSfxDefines>= 1) Then
					;index = fn_Get_SpriteIndex_User()
					Local $ofs1 = 4*17*0 ; todo user selected sprite
					FileSetPos($bFile, $hdr_offsetSfxDefines+$ofs1,$FILE_BEGIN);set to offset
					For $iI = 0 to 3;read integer
						$aSFX_define[$iI] = _WinAPI_SwapDWord(dec(hex(FileRead($bFile, 4), 8)))
					Next
					;ConsoleWrite(">sfx def flags= "&$aSFX_define[1]&@CRLF)
					$aSFX_define[4] = 		Round(_WinAPI_IntToFloat( _WinAPI_SwapDWord(dec(hex(FileRead($bFile, 4), 8)))), 2)
					$aSFX_define[5] = 		_WinAPI_SwapDWord(dec(hex(FileRead($bFile, 4), 8)))

					For $iI = 6 to 16 ;read float
						$aSFX_define[$iI] = Round(_WinAPI_IntToFloat(_WinAPI_SwapDWord(dec(hex(FileRead($bFile, 4), 8)))), 2)
					Next
					;
					if ($hdr_numSfxDefines> 1) Then
						for $iI = 2 To $hdr_numSfxDefines
							FileSetPos($bFile, $hdr_offsetSfxDefines + (($iI-1)* $iSFX_DEF_SIZE),FileSetPos);set to offset
							$model_DATA_SFXDef[$iI] = hex(FileRead($bFile, $iSFX_DEF_SIZE))
						Next
					EndIf
				EndIf

				if ($hdr_numSfxEntries >= 1) Then
					FileSetPos($bFile, $hdr_offsetSfxEntries,0);set to offset
					$aSFX_add[0] = _WinAPI_SwapDWord(dec(hex(FileRead($bFile, 4), 8))); vertex index (0-based)
					$aSFX_add[1] = _WinAPI_SwapDWord(dec(hex(FileRead($bFile, 4), 8))); int define noumber
					$aSFX_add[2] = _WinAPI_SwapDWord(dec(hex(FileRead($bFile, 4), 8))); int vertex/tri (0/1)
					$aSFX_add[3] = FileRead($bFile, 64)
					$aSFX_add[3] = hex($aSFX_add[3])

					ConsoleWrite("bin="&$aSFX_add[3]&@CRLF)
					;_ArrayDisplay($aSFX_add)
					;
					;ConsoleWrite("numSfxEntries=" &$hdr_numSfxEntries & " SFX0=" &$aSFX_add[0]& " SFX1="  &$aSFX_add[1]& " SFX2="  &$aSFX_add[2]& " SFX3="  &$aSFX_add[3]& @CRLF)
					if ($hdr_numSfxEntries > 1) Then
						for $iI = 2 To $hdr_numSfxEntries
							ConsoleWrite("!sfxEntry" &@CRLF)
							FileSetPos($bFile, $hdr_offsetSfxEntries + (($iI-1)* $iSFX_ENTRY_SIZE),0);set to offset
							$model_DATA_SFXEntry[$iI] = hex(FileRead($bFile, $iSFX_ENTRY_SIZE))
						Next
					EndIf
				EndIf

				if ($hdr_numSfxEntries >= 1) And ($hdr_numSfxDefines >= 1) Then
					GUICtrlSetState($Checkbox2,$GUI_CHECKED )
				EndIf

				FileSetPos($bFile, $hdr_offsetBBoxFrames, $FILE_BEGIN)
				$model_DATA_END = hex(FileRead($bFile, $hdr_offsetEnd - $hdr_offsetBBoxFrames))
			Else;==>end mdx
				;md2
				FileSetPos($bFile, $hdr_offsetGlCommands, $FILE_BEGIN)
				$model_DATA_END = hex(FileRead($bFile,$hdr_offsetEnd -  $hdr_offsetGlCommands))
			EndIf;==>end md2
		EndIf
		FileClose($bFile) ;close file


		fn_FillSkinInput()
		fn_Fill_Scale();todo: scale
		;=======

		if ($modelType = $iSMDX) Then
			if ($hdr_numSfxEntries >= 1) Then
				Local $tmp2 = $aSFX_add[3]
				local $fNum =0
				;64 chars
				For $iI = 0 to 63
					Local $sTmp = Dec(StringLeft($tmp2, 2))
					ConsoleWrite("bits=" & $sTmp &@CRLF)

					;read bits backwards
					if BitAND($sTmp, 128) Then $aFrames[$fNum+0] = 1
					if BitAND($sTmp, 64)  Then $aFrames[$fNum+1] = 1
					if BitAND($sTmp, 32)  Then $aFrames[$fNum+2] = 1
					if BitAND($sTmp, 16)  Then $aFrames[$fNum+3] = 1
					if BitAND($sTmp, 8)   Then $aFrames[$fNum+4] = 1
					if BitAND($sTmp, 4)   Then $aFrames[$fNum+5] = 1
					if BitAND($sTmp, 2)   Then $aFrames[$fNum+6] = 1
					if BitAND($sTmp, 1)   Then $aFrames[$fNum+7] = 1

					$tmp2 = StringTrimLeft($tmp2, 2)
					$fNum+=8
				Next
			EndIf
			;_ArrayDisplay($aFrames)

			if ($hdr_numSfxEntries >= 1) And  ($hdr_numSfxDefines >= 1) Then
				fn_Fill_SpriteTab()
				if ($hdr_numSfxEntries > 1) Or  ($hdr_numSfxDefines > 1) Then
					fn_MSG_box(	"Multiple sprite defined.", _
								"Using first index.", 1)
				EndIf
			EndIf

			;check for incorrect offsets
			if ($hdr_offsetTriangles_size < 0) Or ($hdr_offsetFrames_size < 0) Or ($hdr_offsetGlCommands_size < 0) Or _
				($hdr_offsetVertexInfo_size < 0) Or ($hdr_offsetBBoxFrames_size < 0) Or ($hdr_offsetDummyEnd_size < 0) Then
				fn_MSG_box("Input file offset issue.", "This may effect output.")
			EndIf
		;==>end MDX
		Elseif ($modelType = $iSMD2) Then
			if ($hdr_offsetTexCoords_size < 0) Or ($hdr_offsetTriangles_size < 0) Or _
				($hdr_offsetFrames_size < 0) Or ($hdr_offsetGlCommands_size < 0) Then
				fn_MSG_box("Input file offset issue.", "This may effect output.", 1)
			EndIf
		;==>end MD2
		EndIf
	EndIf;==>end FileExists

EndFunc ;==>end fn_ImportModel

;set output file name
Func btn_export_fileClick()
	Local $fileName = ""
	If $modelType = $iSMDX Then
		$fileName = FileSaveDialog("Kingpin Model", $fileOpenDialogPath, "Kingpin Models (*.mdx)",2 ,"", $KPModelSkins)
	ElseIf $modelType = $iSMD2 Then
		$fileName = FileSaveDialog("Kingpin Model", $fileOpenDialogPath, "Kingpin Models (*.md2)",2 ,"", $KPModelSkins)
	ElseIf $modelType = $iSMD3 Then
		$fileName = FileSaveDialog("Quake2 Model", $fileOpenDialogPath, "Quake3 Models (*.md3)",2 ,"", $KPModelSkins)
	EndIf

	If not @error Then
		$exportFileName = $fileName
		fn_SetCurrentFolder($fileName)

		GUICtrlSetData($in_model_export, $fileName)
	EndIf
EndFunc

Func Export_MD3()
	Local $hFile, $nBytes, $tBuffer, $iLen, $skinHex
	if StringCompare($importFileName, $exportFileName) Then
		if Not FileCopy($importFileName, $exportFileName, 1) Then
			fn_MSG_box("Can't write output file.", "", 1)
			Return
		EndIf
	EndIf

	$tBuffer = DllStructCreate("byte[64]")
	$hFile = _WinAPI_CreateFile($exportFileName, 2, 4)
	if not $hFile Then
		fn_MSG_box("Can't open output file.")
		Return
	EndIf

	fn_ProcessInputSkins() ; get skin from input boxes

	;overwrite file
	for $i1 = 1 to $g_iMD3_tex
		$iLen = StringLen($skin[$i1])
		$skinHex = _StringToHex($skin[$i1])
		;finish of with null
		For $j1 = $iLen+1 To 64
			$skinHex &= "00"
		Next
		;ConsoleWrite("$skinHex="&$skin[$i1]&@CRLF)
		DllStructSetData($tBuffer, 1, "0x"&$skinHex)
		_WinAPI_SetFilePointer($hFile, $g_aMD3_surf[$i1][0], $FILE_BEGIN)
		_WinAPI_WriteFile($hFile, $tBuffer, 64, $nBytes)
	Next
	_WinAPI_CloseHandle($hFile)

EndFunc

;click GO
Func btn_export_GOClick()
	Local $offssetToAdd = 0, $offssetToAdd_SFX1 =0, $offssetToAdd_SFX2 =0
	Local $iLen, $skinHex =""
	local $aheader[23]
	Local $bFile

	If $modelType = 0 Then
		fn_MSG_box("No valid model loaded.")
		Return
	EndIf

	; backup file. dont overwrite if it exists
	If _IsChecked($Checkbox1) Then
		Local $isOK = FileCopy($importFileName, string($importFileName&".backup") ,0)
		if Not $isOK And Not FileExists(string($importFileName&".backup")) Then
			;MsgBox(0,"ERROR:", "Cant write backup file",0, $KPModelSkins)
			fn_MSG_box("Can't write backup file.", "", 1)
		EndIf
	EndIf

	if $modelType = $iSMD3 Then
		Export_MD3()
		Return
	EndIf

	$bFile = FileOpen ( $exportFileName,  $FO_OVERWRITE+$FO_CREATEPATH+$FO_BINARY)
	if $bFile = -1 Then
		fn_MSG_box("Can't open output file.")
		Return
	EndIf

	;fix header offset size. compensate for adding a new SFX
	If ($modelType = $iSMDX) Then
		if _IsChecked($Checkbox2) Then
			if ($hdr_numSfxDefines = 0) Then $hdr_numSfxDefines = 1
			if ($hdr_numSfxEntries = 0) Then $hdr_numSfxEntries = 1
		EndIf
		$offssetToAdd_SFX1 = $iSFX_DEF_SIZE*$hdr_numSfxDefines ;17*int (sdk=68)
		$offssetToAdd_SFX2 = $iSFX_ENTRY_SIZE*$hdr_numSfxEntries ;3*int + 64bytes (sdk=140)
	EndIf

	Local $skinCount = fn_ProcessInputSkins()

	$hdr_skinWidth = GUICtrlRead($in_size_w)
	$hdr_skinHeight= GUICtrlRead($in_size_h)

	FileWrite ( $bFile, "0x"&$hdr_magic);IPDX		#0
	$aheader[1] = $hdr_version		;version 4		#1
	$aheader[2] = $hdr_skinWidth	;width			#2
	$aheader[3] = $hdr_skinHeight	;height			#3
	$aheader[4] = $hdr_frameSize	;frame size		#4
	$aheader[5] = $skinCount 		;num skins 		#5
	$aheader[6] = $hdr_numVertices	;num verts		#6


	If ($modelType = $iSMDX) Then
		$aheader[7] = $hdr_numTriangles				;num tri		#7
		$aheader[8] = $hdr_numGlCommands			;num glCmd		#8
		$aheader[9] = $hdr_numFrames				;num frames		#9
		$aheader[10] = $hdr_numSfxDefines			;num sfxDef		#10
		$aheader[11] = $hdr_numSfxEntries			;num sfxEntry	#11
		$aheader[12] = $hdr_numSubObjects			;num subObj		#12
		$aheader[13] = $hdr_offsetSkins_size						;ofs Skins		#13
		$aheader[14] = $aheader[13] + $skinCount*64					;ofs tri		#14
		$aheader[15] = $aheader[14] + $hdr_offsetTriangles_size		;ofs frames		#15
		$aheader[16] = $aheader[15] + $hdr_offsetFrames_size		;ofs glCmd		#16
		$aheader[17] = $aheader[16] + $hdr_offsetGlCommands_size	;ofs vertInfo	#17
		$aheader[18] = $aheader[17] + $hdr_offsetVertexInfo_size	;ofs sfxDef		#18
		$aheader[19] = $aheader[18] + $offssetToAdd_SFX1			;ofs sfxEntry	#19
		$aheader[20] = $aheader[19] + $offssetToAdd_SFX2 			;ofs bbox 		#20
		$aheader[21] = $aheader[20] + $hdr_offsetDummyEnd_size 		;ofs dummy 		#21
		$aheader[22] = $aheader[20] + $hdr_offsetBBoxFrames_size 	;ofs end		#22
		for $iI = 1 to 22
			FileWrite ( $bFile, "0x"&fn_Swap4Bytes(hex($aheader[$iI], 8)))
		Next
		ConsoleWrite("--> File MDX"&@CRLF)
	ElseIf ($modelType = $iSMD2) Then
		$aheader[7] = $hdr_numTexCoords			;num ST				#7
		$aheader[8] = $hdr_numTriangles			;num tri			#8
		$aheader[9] = $hdr_numGlCommands		;num glCmd			#9
		$aheader[10] = $hdr_numFrames			;num frames			#10
		$aheader[11] = $hdr_offsetSkins_size						;ofs  skins			#11
		$aheader[12] = $aheader[11] + $skinCount*64					;ofs ST				#12
		$aheader[13] = $aheader[12] + $hdr_offsetTexCoords_size		;ofs tri			#13
		$aheader[14] = $aheader[13] + $hdr_offsetTriangles_size		;ofs frames			#14
		$aheader[15] = $aheader[14] + $hdr_offsetFrames_size		;ofs glCmd			#15
		$aheader[16] = $aheader[15] + $hdr_offsetGlCommands_size	;ofs end			#16
		for $iI = 1 to 16
			FileWrite ( $bFile, "0x"&fn_Swap4Bytes(hex($aheader[$iI], 8)))
		Next
		ConsoleWrite("--> File MD2"&@CRLF)
		ConsoleWrite("--> hdr11="&$aheader[11]&" hdr12="& $aheader[12] &" hdr13="&$aheader[13]& _
						" hdr14="&$aheader[14]&" hdr15="& $aheader[15] &" hdr13="&$aheader[16]& @CRLF)
	EndIf

	;build skin string
	For $i1 = 1 To $skinCount
		$iLen = StringLen($skin[$i1])
		$skinHex &= _StringToHex($skin[$i1])
		;finish of with null
		For $j1 = $iLen+1 To 64
			$skinHex &= "00"
		Next
	Next

	;write skins
	if $skinCount > 0 Then FileWrite ( $bFile, "0x"&$skinHex)
	$skinHex=""

	;md2 write textcords
	if ($modelType = $iSMD2) Then
		For $i1 = 0 To ($hdr_numTexCoords-1)
			FileWrite ( $bFile, "0x"&fn_Swap4Bytes(hex(int($hdr_TexCoords[$i1][0]*$hdr_skinWidth),4)))
			FileWrite ( $bFile, "0x"&fn_Swap4Bytes(hex(Int($hdr_TexCoords[$i1][1]*$hdr_skinHeight),4)))
		Next
	EndIf

	;write triangle data
	FileWrite ( $bFile, "0x"&$model_DATA_tri)

	;write frame scale
	fn_Update_Scale()
	For $iI = 0 to 5 ;float
		ConsoleWrite("!0x"&fn_Swap4Bytes(hex(_WinAPI_FloatToInt($model_DATA_scale[$iI]), 8))& @CRLF)
		FileWrite ( $bFile, "0x"&fn_Swap4Bytes(hex(_WinAPI_FloatToInt($model_DATA_scale[$iI]), 8)))
	Next

	;write frame data
	FileWrite ( $bFile, "0x"&$model_DATA_frame)

	;mdx write SFX
	If ($modelType = $iSMDX) Then
		;FileWrite ( $bFile, "0x"&$model_DATA_preSFX)

		;setup local arrays with gui data
		fn_Get_SpriteTab_Data()

		if ($hdr_numSfxDefines >= 1) Then
			For $iI = 0 to 3;integer
				FileWrite ( $bFile, "0x"&fn_Swap4Bytes(hex($aSFX_define[$iI], 8)))
			Next
			FileWrite ( $bFile, "0x"&fn_Swap4Bytes(hex(_WinAPI_FloatToInt($aSFX_define[4]), 8)))
			FileWrite ( $bFile, "0x"&fn_Swap4Bytes(hex($aSFX_define[5], 8)))
			For $iI = 6 to 16;float
				FileWrite ( $bFile, "0x"&fn_Swap4Bytes(hex(_WinAPI_FloatToInt($aSFX_define[$iI]), 8)))
			Next
			;write extra entries
			if ($hdr_numSfxDefines > 1) Then
				for $iI = 2 To $hdr_numSfxDefines
					ConsoleWrite("+sfxDef" &@CRLF)
					FileWrite ( $bFile, "0x"&$model_DATA_SFXDef[$iI])
				Next
			EndIf
		EndIf ;==> end sfx defines

		if ($hdr_numSfxEntries >= 1) Then
			FileWrite ( $bFile, "0x"&fn_Swap4Bytes(hex($aSFX_add[0], 8))) ; vertex #
			FileWrite ( $bFile, "0x"&fn_Swap4Bytes(hex($aSFX_add[1], 8))) ; sfx define index
			FileWrite ( $bFile, "0x"&fn_Swap4Bytes(hex($aSFX_add[2], 8))) ; 0=vertex
			local $fNum =0
			For $iI = 0 to 63
				Local $sTmp = 0
				;write bits backwards
				if ($aFrames[$fNum+0] = 1) Then $sTmp = BitOR($sTmp, 128)
				if ($aFrames[$fNum+1] = 1) Then $sTmp = BitOR($sTmp, 64)
				if ($aFrames[$fNum+2] = 1) Then $sTmp = BitOR($sTmp, 32)
				if ($aFrames[$fNum+3] = 1) Then $sTmp = BitOR($sTmp, 16)
				if ($aFrames[$fNum+4] = 1) Then $sTmp = BitOR($sTmp, 8)
				if ($aFrames[$fNum+5] = 1) Then $sTmp = BitOR($sTmp, 4)
				if ($aFrames[$fNum+6] = 1) Then $sTmp = BitOR($sTmp, 2)
				if ($aFrames[$fNum+7] = 1) Then $sTmp = BitOR($sTmp, 1)

				$fNum+=8
				FileWrite ( $bFile, "0x"&hex($sTmp,2))
			Next
			;write extra entries
			if ($hdr_numSfxEntries > 1) Then
				for $iI = 2 To $hdr_numSfxEntries
					ConsoleWrite("+sfxEntry" &@CRLF)
					FileWrite ( $bFile, "0x"&$model_DATA_SFXEntry[$iI])
				Next
			EndIf

			GUICtrlSetState($Checkbox2,$GUI_CHECKED)
		EndIf ;==> end sfx entries
	EndIf ;==> end mdx

	;write end data
	FileWrite ( $bFile, "0x"&$model_DATA_END)


	FileClose($bFile)

	ConsoleWrite (	"+File Saved"&@CRLF)
	fn_MSG_box("Model Saved.")

EndFunc

#EndRegion

#Region ;==> GUI. MESSAGE BOX
Func fn_MSG_box($sLine1, $sLine2 = "", $pauseScript = 0)
	Local $aPos = WinGetPos ( $KPModelSkins )
	WinMove($Form1_msgbox, "", $aPos[0]+200, $aPos[1]+200)
	GUICtrlSetData($Label1_msgbox, $sLine1)
	GUICtrlSetData($Label2_msgbox, $sLine2)
	GUISetState(@SW_DISABLE,$KPModelSkins)
	GUISetState(@SW_SHOW,$Form1_msgbox)

	if ($pauseScript = 1) Then
		$isActive_msgBox = 1
		Opt("GUIOnEventMode", 0)
		While ($isActive_msgBox = 1)
			 Switch (GUIGetMsg())
				Case $GUI_EVENT_CLOSE
					Form1_msgboxClose()
				Case $Button1_msgbox
					Form1_msgboxClose()
			 EndSwitch
			 Sleep(20)
		WEnd
		Opt("GUIOnEventMode", 1)
	EndIf
EndFunc

Func Form1_msgboxClose()
	GUISetState(@SW_HIDE, $Form1_msgbox)
	GUISetState(@SW_ENABLE, $KPModelSkins )
	GUISetState(@SW_RESTORE, $KPModelSkins)
	$isActive_msgBox = 0
EndFunc
#EndRegion

#Region ;==> SKIN CHOOSER BUTTONS
Func btn_skin_1Click()
	GUICtrlSetData($in_skin_1, fn_OpenFile_GetSkinName(GUICtrlRead($in_skin_1)))
EndFunc
Func btn_skin_2Click()
	GUICtrlSetData($in_skin_2, fn_OpenFile_GetSkinName(GUICtrlRead($in_skin_2)))
EndFunc
Func btn_skin_3Click()
	GUICtrlSetData($in_skin_3, fn_OpenFile_GetSkinName(GUICtrlRead($in_skin_3)))
EndFunc
Func btn_skin_4Click()
	GUICtrlSetData($in_skin_4, fn_OpenFile_GetSkinName(GUICtrlRead($in_skin_4)))
EndFunc
Func btn_skin_5Click()
	GUICtrlSetData($in_skin_5, fn_OpenFile_GetSkinName(GUICtrlRead($in_skin_5)))
EndFunc
Func btn_skin_6Click()
	GUICtrlSetData($in_skin_6, fn_OpenFile_GetSkinName(GUICtrlRead($in_skin_6)))
EndFunc
Func btn_skin_7Click()
	GUICtrlSetData($in_skin_7, fn_OpenFile_GetSkinName(GUICtrlRead($in_skin_7)))
EndFunc
Func btn_skin_8Click()
	GUICtrlSetData($in_skin_8, fn_OpenFile_GetSkinName(GUICtrlRead($in_skin_8)))
EndFunc
Func btn_skin_9Click()
	GUICtrlSetData($in_skin_9, fn_OpenFile_GetSkinName(GUICtrlRead($in_skin_9)))
EndFunc
Func btn_skin_10Click()
	GUICtrlSetData($in_skin_10, fn_OpenFile_GetSkinName(GUICtrlRead($in_skin_10)))
EndFunc
Func btn_skin_11Click()
	GUICtrlSetData($in_skin_11, fn_OpenFile_GetSkinName(GUICtrlRead($in_skin_11)))
EndFunc
Func btn_skin_12Click()
	GUICtrlSetData($in_skin_12, fn_OpenFile_GetSkinName(GUICtrlRead($in_skin_12)))
EndFunc
Func btn_skin_13Click()
	GUICtrlSetData($in_skin_13, fn_OpenFile_GetSkinName(GUICtrlRead($in_skin_13)))
EndFunc
Func btn_skin_14Click()
	GUICtrlSetData($in_skin_14, fn_OpenFile_GetSkinName(GUICtrlRead($in_skin_14)))
EndFunc
Func btn_skin_15Click()
	GUICtrlSetData($in_skin_15, fn_OpenFile_GetSkinName(GUICtrlRead($in_skin_15)))
EndFunc
Func btn_skin_16Click()
	GUICtrlSetData($in_skin_16, fn_OpenFile_GetSkinName(GUICtrlRead($in_skin_16)))
EndFunc
Func btn_skin_17Click()
	GUICtrlSetData($in_skin_17, fn_OpenFile_GetSkinName(GUICtrlRead($in_skin_17)))
EndFunc
Func btn_skin_18Click()
	GUICtrlSetData($in_skin_18, fn_OpenFile_GetSkinName(GUICtrlRead($in_skin_18)))
EndFunc
Func btn_skin_19Click()
	GUICtrlSetData($in_skin_19, fn_OpenFile_GetSkinName(GUICtrlRead($in_skin_19)))
EndFunc
Func btn_skin_20Click()
	GUICtrlSetData($in_skin_20, fn_OpenFile_GetSkinName(GUICtrlRead($in_skin_20)))
EndFunc
Func btn_skin_21Click()
	GUICtrlSetData($in_skin_21, fn_OpenFile_GetSkinName(GUICtrlRead($in_skin_21)))
EndFunc
Func btn_skin_22Click()
	GUICtrlSetData($in_skin_22, fn_OpenFile_GetSkinName(GUICtrlRead($in_skin_22)))
EndFunc
Func btn_skin_23Click()
	GUICtrlSetData($in_skin_23, fn_OpenFile_GetSkinName(GUICtrlRead($in_skin_23)))
EndFunc
Func btn_skin_24Click()
	GUICtrlSetData($in_skin_24, fn_OpenFile_GetSkinName(GUICtrlRead($in_skin_24)))
EndFunc
Func btn_skin_25Click()
	GUICtrlSetData($in_skin_25, fn_OpenFile_GetSkinName(GUICtrlRead($in_skin_25)))
EndFunc
Func btn_skin_26Click()
	GUICtrlSetData($in_skin_26, fn_OpenFile_GetSkinName(GUICtrlRead($in_skin_26)))
EndFunc
Func btn_skin_27Click()
	GUICtrlSetData($in_skin_27, fn_OpenFile_GetSkinName(GUICtrlRead($in_skin_27)))
EndFunc
Func btn_skin_28Click()
	GUICtrlSetData($in_skin_28, fn_OpenFile_GetSkinName(GUICtrlRead($in_skin_28)))
EndFunc
Func btn_skin_29Click()
	GUICtrlSetData($in_skin_29, fn_OpenFile_GetSkinName(GUICtrlRead($in_skin_29)))
EndFunc
Func btn_skin_30Click()
	GUICtrlSetData($in_skin_30, fn_OpenFile_GetSkinName(GUICtrlRead($in_skin_30)))
EndFunc
Func btn_skin_31Click()
	GUICtrlSetData($in_skin_31, fn_OpenFile_GetSkinName(GUICtrlRead($in_skin_31)))
EndFunc
Func btn_skin_32Click()
	GUICtrlSetData($in_skin_32, fn_OpenFile_GetSkinName(GUICtrlRead($in_skin_32)))
EndFunc

#EndRegion

#Region ;==> SKIN TAB
;buttons

Func fn_TrimFilePath($fileTempName)
	Local $iIdx = StringInStr($fileTempName, "models\")
	if  $iIdx Then
		$fileTempName = StringMid($fileTempName, $iIdx)
	Else
		$iIdx = StringInStr($fileTempName, "players\")
		if  $iIdx Then
			$fileTempName = StringMid($fileTempName, $iIdx)
		Else
			$iIdx = StringInStr($fileTempName, "textures\")
			if  $iIdx Then
				$fileTempName = StringMid($fileTempName, $iIdx)
			Else
				$iIdx = StringInStr($fileTempName, "kingpin\")
				if  $iIdx Then
					$fileTempName = StringMid($fileTempName, $iIdx+8)
					$iIdx = StringInStr($fileTempName, "\")
					$fileTempName = StringMid($fileTempName, $iIdx+1)
				Else
					$iIdx = StringInStr($fileTempName, "quake2\")
					if  $iIdx Then
						$fileTempName = StringMid($fileTempName, $iIdx+8)
						$iIdx = StringInStr($fileTempName, "\")
						$fileTempName = StringMid($fileTempName, $iIdx+1)
					EndIf
				EndIf
			EndIf
		EndIf
	EndIf

	Return StringReplace($fileTempName, "\", "/")

EndFunc

Func fn_FillSkinInput()
	GUICtrlSetData($in_skin_1, $skin[1])
	GUICtrlSetData($in_skin_2, $skin[2])
	GUICtrlSetData($in_skin_3, $skin[3])
	GUICtrlSetData($in_skin_4, $skin[4])
	GUICtrlSetData($in_skin_5, $skin[5])
	GUICtrlSetData($in_skin_6, $skin[6])
	GUICtrlSetData($in_skin_7, $skin[7])
	GUICtrlSetData($in_skin_8, $skin[8])
	GUICtrlSetData($in_skin_9, $skin[9])
	GUICtrlSetData($in_skin_10, $skin[10])
	GUICtrlSetData($in_skin_11, $skin[11])
	GUICtrlSetData($in_skin_12, $skin[12])
	GUICtrlSetData($in_skin_13, $skin[13])
	GUICtrlSetData($in_skin_14, $skin[14])
	GUICtrlSetData($in_skin_15, $skin[15])
	GUICtrlSetData($in_skin_16, $skin[16])
	GUICtrlSetData($in_skin_17, $skin[17])
	GUICtrlSetData($in_skin_18, $skin[18])
	GUICtrlSetData($in_skin_19, $skin[19])
	GUICtrlSetData($in_skin_20, $skin[20])
	GUICtrlSetData($in_skin_21, $skin[21])
	GUICtrlSetData($in_skin_22, $skin[22])
	GUICtrlSetData($in_skin_23, $skin[23])
	GUICtrlSetData($in_skin_24, $skin[24])
	GUICtrlSetData($in_skin_25, $skin[25])
	GUICtrlSetData($in_skin_26, $skin[26])
	GUICtrlSetData($in_skin_27, $skin[27])
	GUICtrlSetData($in_skin_28, $skin[28])
	GUICtrlSetData($in_skin_29, $skin[29])
	GUICtrlSetData($in_skin_30, $skin[30])
	GUICtrlSetData($in_skin_31, $skin[31])
	GUICtrlSetData($in_skin_32, $skin[32])
EndFunc

Func fn_OpenFile_GetSkinName($origSkin)
	Local $fileTempName = FileOpenDialog("Skin", $fileOpenDialogPath, "Kingpin Textures(*.tga;*.pcx)|All Files (*.*)",1,"",$KPModelSkins)

	if not @error Then
		fn_SetCurrentFolder($fileTempName)
		Return fn_TrimFilePath($fileTempName)
	EndIf

	;error getting file. return orig string
	Return $origSkin
EndFunc

Func fn_ProcessInputSkins()
	Local $iCount=0
	Local $sTempSkins[$iMAXSKIN+1]

	$sTempSkins[1] = GUICtrlRead($in_skin_1)
	$sTempSkins[2] = GUICtrlRead($in_skin_2)
	$sTempSkins[3] = GUICtrlRead($in_skin_3)
	$sTempSkins[4] = GUICtrlRead($in_skin_4)
	$sTempSkins[5] = GUICtrlRead($in_skin_5)
	$sTempSkins[6] = GUICtrlRead($in_skin_6)
	$sTempSkins[7] = GUICtrlRead($in_skin_7)
	$sTempSkins[8] = GUICtrlRead($in_skin_8)
	$sTempSkins[9] = GUICtrlRead($in_skin_9)
	$sTempSkins[10] = GUICtrlRead($in_skin_10)
	$sTempSkins[11] = GUICtrlRead($in_skin_11)
	$sTempSkins[12] = GUICtrlRead($in_skin_12)
	$sTempSkins[13] = GUICtrlRead($in_skin_13)
	$sTempSkins[14] = GUICtrlRead($in_skin_14)
	$sTempSkins[15] = GUICtrlRead($in_skin_15)
	$sTempSkins[16] = GUICtrlRead($in_skin_16)
	$sTempSkins[17] = GUICtrlRead($in_skin_17)
	$sTempSkins[18] = GUICtrlRead($in_skin_18)
	$sTempSkins[19] = GUICtrlRead($in_skin_19)
	$sTempSkins[20] = GUICtrlRead($in_skin_20)
	$sTempSkins[21] = GUICtrlRead($in_skin_21)
	$sTempSkins[22] = GUICtrlRead($in_skin_22)
	$sTempSkins[23] = GUICtrlRead($in_skin_23)
	$sTempSkins[24] = GUICtrlRead($in_skin_24)
	$sTempSkins[25] = GUICtrlRead($in_skin_25)
	$sTempSkins[26] = GUICtrlRead($in_skin_26)
	$sTempSkins[27] = GUICtrlRead($in_skin_27)
	$sTempSkins[28] = GUICtrlRead($in_skin_28)
	$sTempSkins[29] = GUICtrlRead($in_skin_29)
	$sTempSkins[30] = GUICtrlRead($in_skin_30)
	$sTempSkins[31] = GUICtrlRead($in_skin_31)
	$sTempSkins[32] = GUICtrlRead($in_skin_32)

	For $i1 = 1 to $iMAXSKIN
		If $sTempSkins[$i1] <> "" Then
			$iCount+=1
			$skin[$iCount]= StringMid($sTempSkins[$i1],1, 64)
		EndIf
	Next
	Return Number($iCount)
EndFunc

Func fn_ResetSkinInput()
	for $i1 = 1 to $iMAXSKIN
		$skin[$i1] =""
	Next
	fn_FillSkinInput()
EndFunc


Func btn_clearClick()
	fn_ResetSkinInput()
EndFunc


#EndRegion

#Region ;==> SPRITES TAB
;buttons
Func Button_Sprite_ExportClick()
	fn_Export_QDT()
EndFunc
Func Button_Sprite_ImportClick()
	fn_Import_QDT()
EndFunc
Func Button_Sprite_ResetClick()
	fn_Reset_SpriteTab_Data()
EndFunc

Func Checkbox2Click()
	;only allow edit if not defined in mdx
	if ($hdr_numSfxEntries = 0) And ($hdr_numSfxDefines = 0) Then
		If _IsChecked($Checkbox2) Then
			GUICtrlSetState($Checkbox2, $GUI_UNCHECKED)
		Else
			if ($modelType = $iSMDX) Then GUICtrlSetState($Checkbox2,$GUI_CHECKED)
		EndIf
	EndIf
EndFunc

fn_ResetSFX_arrays()
Func fn_ResetSFX_arrays()
	Local $iI
	for $iI = 0 to 16
		$aSFX_define[$iI] = ""
	Next
	for $iI = 0 to 3
		$aSFX_add[$iI] = ""
	Next
	for $iI = 0 to 511
		$aFrames[$iI] = 0
	Next
EndFunc

fn_ResetSFX_DATA()
Func fn_ResetSFX_DATA()
	for $iI = 0 to 24
		$model_DATA_SFXDef[$iI] = ""
		$model_DATA_SFXEntry[$iI] = ""
	Next
	$model_DATA_preSFX = ""
	$model_DATA_END = ""
EndFunc


fn_Reset_SpriteTab_Data()
Func fn_Reset_SpriteTab_Data()
	_GUICtrlComboBox_SetCurSel($Combo1_SFX_Type, 30);type ;101 default pistol
	GuiCtrlSetData($Input1_flags, "0")				;flags
	_GUICtrlComboBox_SetCurSel($Combo2_direction, 0);direction
	GuiCtrlSetData($Input2_speed, "3")				;speed
	GuiCtrlSetData($Input3_gravity, "0")			;gravity
	GuiCtrlSetData($Input4_time, "2")				;time MS
	GuiCtrlSetData($Input5_randTime, "50")			;rand time
	GuiCtrlSetData($Input6_start_alpha, "0.9")		;start alpha
	GuiCtrlSetData($Input7_end_alpha, "0.0")		;end alpha
	GuiCtrlSetData($Input8_fade_in, "0.2")			;fade in
	GuiCtrlSetData($Input9_lifetime, "4.0")			;lifetime
	GuiCtrlSetData($Input10_rand_scale, "0.2")		;rand scale
	GuiCtrlSetData($Input11_start_width, "4.25")	;start width
	GuiCtrlSetData($Input12_end_width, "4.25")		;end width
	GuiCtrlSetData($Input13_start_height, "4.25")	;start height
	GuiCtrlSetData($Input14_end_height, "4.25")		;end height
	GuiCtrlSetData($Input15_rand_w_h, "0.5")		;rand width/height

	GuiCtrlSetData($Input16_vertexID, "0") ;vertex 0-based (-1 will not add any sfx if it did not allready exist)

	GuiCtrlSetData($Input_f_start_1, "8")
	GuiCtrlSetData($Input_f_end_1, "8")
	GuiCtrlSetData($Input_f_start_2, "-1")
	GuiCtrlSetData($Input_f_end_2, "-1")
	GuiCtrlSetData($Input_f_start_3, "-1")
	GuiCtrlSetData($Input_f_end_3, "-1")
	GuiCtrlSetData($Input_f_start_4, "-1")
	GuiCtrlSetData($Input_f_end_4, "-1")
	GuiCtrlSetData($Input_f_start_5, "-1")
	GuiCtrlSetData($Input_f_end_5, "-1")
	GuiCtrlSetData($Input_f_start_6, "-1")
	GuiCtrlSetData($Input_f_end_6, "-1")
	GuiCtrlSetData($Input_f_start_7, "-1")
	GuiCtrlSetData($Input_f_end_7, "-1")
	GuiCtrlSetData($Input_f_start_8, "-1")
	GuiCtrlSetData($Input_f_end_8, "-1")
	GuiCtrlSetData($Input_f_start_9, "-1")
	GuiCtrlSetData($Input_f_end_9, "-1")
	GuiCtrlSetData($Input_f_start_10, "-1")
	GuiCtrlSetData($Input_f_end_10, "-1")


	GUICtrlSetState($box_flags_1, $GUI_UNCHECKED)
	GUICtrlSetState($box_flags_2, $GUI_UNCHECKED)
	GUICtrlSetState($box_flags_4, $GUI_UNCHECKED)
	GUICtrlSetState($box_flags_8, $GUI_UNCHECKED)
	GUICtrlSetState($box_flags_16, $GUI_UNCHECKED)
	GUICtrlSetState($box_flags_32, $GUI_UNCHECKED)
	GUICtrlSetState($box_flags_64, $GUI_UNCHECKED)
	GUICtrlSetState($box_flags_128, $GUI_UNCHECKED)
	GUICtrlSetState($box_flags_256, $GUI_UNCHECKED)
	GUICtrlSetState($box_flags_512, $GUI_UNCHECKED)
 	GUICtrlSetState($box_flags_1024, $GUI_UNCHECKED)
;~ 	GUICtrlSetState($box_flags_2048, $GUI_UNCHECKED)
;~ 	GUICtrlSetState($box_flags_4096, $GUI_UNCHECKED)
;~ 	GUICtrlSetState($box_flags_8192, $GUI_UNCHECKED)
;~ 	GUICtrlSetState($box_flags_16384, $GUI_UNCHECKED)
;~ 	GUICtrlSetState($box_flags_32768, $GUI_UNCHECKED)

;sprite image reset
Combo1_SFX_TypeChange()

EndFunc

Func fn_FillFlags_chkBox()
	Local $flagsStr = int(GUICtrlRead($Input1_flags))

	if BitAND($flagsStr, 1) Then GUICtrlSetState($box_flags_1, $GUI_CHECKED)
	if BitAND($flagsStr, 2) Then GUICtrlSetState($box_flags_2, $GUI_CHECKED)
	if BitAND($flagsStr, 4) Then GUICtrlSetState($box_flags_4, $GUI_CHECKED)
	if BitAND($flagsStr, 8) Then GUICtrlSetState($box_flags_8, $GUI_CHECKED)
	if BitAND($flagsStr, 16) Then GUICtrlSetState($box_flags_16, $GUI_CHECKED)
	if BitAND($flagsStr, 32) Then GUICtrlSetState($box_flags_32, $GUI_CHECKED)
	if BitAND($flagsStr, 64) Then GUICtrlSetState($box_flags_64, $GUI_CHECKED)
	if BitAND($flagsStr, 128) Then GUICtrlSetState($box_flags_128, $GUI_CHECKED)
	if BitAND($flagsStr, 256) Then GUICtrlSetState($box_flags_256, $GUI_CHECKED)
	if BitAND($flagsStr, 512) Then GUICtrlSetState($box_flags_512, $GUI_CHECKED)
 	if BitAND($flagsStr, 1024) Then GUICtrlSetState($box_flags_1024, $GUI_CHECKED)
;~ 	if BitAND($flagsStr, 2048) Then GUICtrlSetState($box_flags_2048, $GUI_CHECKED)
;~ 	if BitAND($flagsStr, 4096) Then GUICtrlSetState($box_flags_4096, $GUI_CHECKED)
;~ 	if BitAND($flagsStr, 8192) Then GUICtrlSetState($box_flags_8192, $GUI_CHECKED)
;~ 	if BitAND($flagsStr, 16384) Then GUICtrlSetState($box_flags_16384, $GUI_CHECKED)
;~ 	if BitAND($flagsStr, 32768) Then GUICtrlSetState($box_flags_32768, $GUI_CHECKED)

EndFunc


;qdt/mdx file loaded and internal arrays set, now fill UI
Func fn_Fill_SpriteTab()
	;SFX Type
	Local $iNum = int(Number($aSFX_define[0]))
	Local $iSFXTypeIndex = 30 ;default pistol
	For $iI = 0 to 48
		if $aSFX_Type[$iI] = $iNum Then
			$iSFXTypeIndex = $iI
			ExitLoop
		EndIf
	Next

	;direction
	Local $upDown = int(Number($aSFX_define[2]))
	Local $upDownIdx = 0 ;default up
	if $upDown =1 Then $upDownIdx = 1


	;use vert/tri?
	Local $VertTri = int(Number($aSFX_add[2]))
	Local $VertTriIdx = 0 ;default vert4ex
	if $VertTri = 1 Then $VertTriIdx = 1

	;$sfx_define
	_GUICtrlComboBox_SetCurSel($Combo1_SFX_Type, $iSFXTypeIndex )
	GuiCtrlSetData($Input1_flags, $aSFX_define[1])
	_GUICtrlComboBox_SetCurSel($Combo2_direction, $upDownIdx)
	GuiCtrlSetData($Input2_speed, $aSFX_define[3])
	GuiCtrlSetData($Input3_gravity, $aSFX_define[4])
	GuiCtrlSetData($Input4_time, $aSFX_define[5])
	GuiCtrlSetData($Input5_randTime, $aSFX_define[6]*100)
	GuiCtrlSetData($Input6_start_alpha, $aSFX_define[7])
	GuiCtrlSetData($Input7_end_alpha, $aSFX_define[8])
	GuiCtrlSetData($Input8_fade_in, $aSFX_define[9])
	GuiCtrlSetData($Input9_lifetime, $aSFX_define[10])
	GuiCtrlSetData($Input10_rand_scale, $aSFX_define[11])
	GuiCtrlSetData($Input11_start_width, $aSFX_define[12])
	GuiCtrlSetData($Input12_end_width, $aSFX_define[13])
	GuiCtrlSetData($Input13_start_height, $aSFX_define[14])
	GuiCtrlSetData($Input14_end_height, $aSFX_define[15])
	GuiCtrlSetData($Input15_rand_w_h, $aSFX_define[16])

	;$sfx_add
	GuiCtrlSetData($Input16_vertexID, $aSFX_add[0]) ;todo add more defines??
	_GUICtrlComboBox_SetCurSel($Combo3_vertTri, $VertTriIdx) ;vertex/tri


	Local $fIdx=0, $iI = 0

	While ($iI < 512 And $fIdx < 10)
		if ($aFrames[$iI]) Then
			$aFrameRange[$fIdx][0] = $iI
			While ( $iI < 512 and $aFrames[$iI])
				$aFrameRange[$fIdx][1] = $iI ;set end time
				$iI+= 1
			WEnd
			$fIdx += 1
		EndIf
		$iI+= 1
	WEnd

	;clear unused input boxes
	For $iI = $fIdx to 9
		$aFrameRange[$iI][0] = -1
		$aFrameRange[$iI][1] = -1
	Next

	;_ArrayDisplay($aFrameRange)
	;todo cleanup
	GuiCtrlSetData($Input_f_start_1, $aFrameRange[0][0])
	GuiCtrlSetData($Input_f_end_1, $aFrameRange[0][1])
	GuiCtrlSetData($Input_f_start_2, $aFrameRange[1][0])
	GuiCtrlSetData($Input_f_end_2, $aFrameRange[1][1])
	GuiCtrlSetData($Input_f_start_3, $aFrameRange[2][0])
	GuiCtrlSetData($Input_f_end_3, $aFrameRange[2][1])
	GuiCtrlSetData($Input_f_start_4, $aFrameRange[3][0])
	GuiCtrlSetData($Input_f_end_4, $aFrameRange[3][1])
	GuiCtrlSetData($Input_f_start_5, $aFrameRange[4][0])
	GuiCtrlSetData($Input_f_end_5, $aFrameRange[4][1])
	GuiCtrlSetData($Input_f_start_6, $aFrameRange[5][0])
	GuiCtrlSetData($Input_f_end_6, $aFrameRange[5][1])
	GuiCtrlSetData($Input_f_start_7, $aFrameRange[6][0])
	GuiCtrlSetData($Input_f_end_7, $aFrameRange[6][1])
	GuiCtrlSetData($Input_f_start_8, $aFrameRange[7][0])
	GuiCtrlSetData($Input_f_end_8, $aFrameRange[7][1])
	GuiCtrlSetData($Input_f_start_9, $aFrameRange[8][0])
	GuiCtrlSetData($Input_f_end_9, $aFrameRange[8][1])
	GuiCtrlSetData($Input_f_start_10, $aFrameRange[9][0])
	GuiCtrlSetData($Input_f_end_10, $aFrameRange[9][1])

	fn_FillFlags_chkBox()

	Combo1_SFX_TypeChange()
EndFunc

;retreve sprite data fron UI. before saving qdt/mdx
Func fn_Get_SpriteTab_Data()
	;SFX Type
	Local $iIndex = $aSFX_Type[_GUICtrlComboBox_GetCurSel($Combo1_SFX_Type)] ; 30 ;default pistol
	;SFX Direction
	Local $upDownIdx = _GUICtrlComboBox_GetCurSel($Combo2_direction) ;0 ;default up
	;SFX use vert/tri
	Local $VertTriIdx = _GUICtrlComboBox_GetCurSel($Combo3_vertTri) ;0 ;default vertex
	fn_ResetSFX_arrays()

	;$sfx_define
	$aSFX_define[0] = 	$iIndex
	$aSFX_define[1] = 	int(GUICtrlRead($Input1_flags))
	$aSFX_define[2] = 	$upDownIdx
	$aSFX_define[3] = 	int(GUICtrlRead($Input2_speed))
	$aSFX_define[4] = 	number(GUICtrlRead($Input3_gravity))
	$aSFX_define[5] = 	int(GUICtrlRead($Input4_time))
	$aSFX_define[6] = 	number(GUICtrlRead($Input5_randTime)/100)
	$aSFX_define[7] = 	number(GUICtrlRead($Input6_start_alpha))
	$aSFX_define[8] = 	number(GUICtrlRead($Input7_end_alpha))
	$aSFX_define[9] = 	number(GUICtrlRead($Input8_fade_in))
	$aSFX_define[10] = 	number(GUICtrlRead($Input9_lifetime))
	$aSFX_define[11] = 	number(GUICtrlRead($Input10_rand_scale))
	$aSFX_define[12] = 	number(GUICtrlRead($Input11_start_width))
	$aSFX_define[13] = 	number(GUICtrlRead($Input12_end_width))
	$aSFX_define[14] = 	number(GUICtrlRead($Input13_start_height))
	$aSFX_define[15] = 	number(GUICtrlRead($Input14_end_height))
	$aSFX_define[16] = 	number(GUICtrlRead($Input15_rand_w_h))

	;$sfx_add
	$aSFX_add[0] = 	int(GUICtrlRead($Input16_vertexID)) ;todo add more defines??
	$aSFX_add[1] = 	0 ;always sprite define index 0
	$aSFX_add[2] = 	$VertTriIdx ;vertex/tri
	;frame range to show effect
	$aFrameRange[0][0]=	int(GUICtrlRead($Input_f_start_1))
	$aFrameRange[0][1]=	int(GUICtrlRead($Input_f_end_1))
	$aFrameRange[1][0]=	int(GUICtrlRead($Input_f_start_2))
	$aFrameRange[1][1]=	int(GUICtrlRead($Input_f_end_2))
	$aFrameRange[2][0]=	int(GUICtrlRead($Input_f_start_3))
	$aFrameRange[2][1]=	int(GUICtrlRead($Input_f_end_3))
	$aFrameRange[3][0]=	int(GUICtrlRead($Input_f_start_4))
	$aFrameRange[3][1]=	int(GUICtrlRead($Input_f_end_4))
	$aFrameRange[4][0]=	int(GUICtrlRead($Input_f_start_5))
	$aFrameRange[4][1]=	int(GUICtrlRead($Input_f_end_5))
	$aFrameRange[5][0]=	int(GUICtrlRead($Input_f_start_6))
	$aFrameRange[5][1]=	int(GUICtrlRead($Input_f_end_6))
	$aFrameRange[6][0]=	int(GUICtrlRead($Input_f_start_7))
	$aFrameRange[6][1]=	int(GUICtrlRead($Input_f_end_7))
	$aFrameRange[7][0]=	int(GUICtrlRead($Input_f_start_8))
	$aFrameRange[7][1]=	int(GUICtrlRead($Input_f_end_8))
	$aFrameRange[8][0]=	int(GUICtrlRead($Input_f_start_9))
	$aFrameRange[8][1]=	int(GUICtrlRead($Input_f_end_9))
	$aFrameRange[9][0]=	int(GUICtrlRead($Input_f_start_10))
	$aFrameRange[9][1]=	int(GUICtrlRead($Input_f_end_10))
	;_ArrayDisplay($aFrameRange)

	For $iI = 0 to 9
		;ConsoleWrite("range start = "&$aFrameRange[$iI][0]& " end=" &$aFrameRange[$iI][1]&@crlf)
		If($aFrameRange[$iI][0] >= 0) and ($aFrameRange[$iI][1] >= 0) And ($aFrameRange[$iI][0] <= $aFrameRange[$iI][1]) Then
			if $aFrameRange[$iI][0] > 511 Then $aFrameRange[$iI][0] = 511
			if $aFrameRange[$iI][1] > 511 Then $aFrameRange[$iI][1] = 511
			For $iJ = $aFrameRange[$iI][0] To $aFrameRange[$iI][1]
				$aFrames[$iJ] = 1
			Next
		EndIf
	Next
	;_ArrayDisplay($aFrames)

EndFunc

Func fn_Import_QDT()
	Local $sfxDefineIdx = 0, $sfxDefineCount = 0, $sfxDefineString = ""
	Local $sfxAddIdx = 0, $sfxAddCount = 0, $sfxAddString =""
	Local $iI, $iJ

	Local $filePath =  FileOpenDialog("kingpin sprites .qdt", $fileOpenDialogPath, "Text files (*.txt;*.qdt)|All files (*.*)", 1,"", $KPModelSkins)
	If Not @error Then
		fn_SetCurrentFolder($filePath)

		Local $aArray = FileReadToArray($filePath)
		If Not @error Then
			Local $idx
			for $iI = 0 to UBound($aArray)-1
				;strip comments
				$idx = StringInStr($aArray[$iI], "//")
				if $idx Then $aArray[$iI] = StringLeft($aArray[$iI],$idx-1)
				;sfx define
				$idx = StringInStr($aArray[$iI], "$sfx_define", 0, 1,1,11)
				if $idx then $sfxDefineIdx = $iI

				$idx = StringInStr($aArray[$iI], "$sfx_add", 0, 1,1,8)
				if $idx then $sfxAddIdx = $iI

				If ($sfxDefineIdx > 0) and  ($iI > $sfxDefineIdx) Then $sfxDefineString &= string($aArray[$iI]& " ")

				;append rest
				If ($sfxAddIdx > 0) And ($iI > $sfxAddIdx) Then $sfxAddString &= string($aArray[$iI]& " ")

			Next
			;ConsoleWrite($sfxDefineString&@CRLF)
			;ConsoleWrite($sfxAddString&@CRLF)

			;todo check exist

			Local  $iCount, $wasNum
			StringStripWS ( $sfxDefineString, 3)
			StringStripWS ( $sfxAddString, 3)
			fn_ResetSFX_arrays()


			$wasNum = 0
			$iCount = 0
			While ($sfxDefineString <> "" And $iCount < 17)
				if StringRegExp($sfxDefineString, '^[\d\.]') Then
					$aSFX_define[$iCount] &= StringLeft($sfxDefineString, 1)
					$wasNum = 1
				Else
					if $wasNum Then $iCount+=1; end of number string. new index
					$wasNum = 0
				EndIf
				$sfxDefineString = StringTrimLeft($sfxDefineString, 1)
			WEnd
			;_ArrayDisplay($aSFX_define)


			;process $sfx_add
			$wasNum = 0
			$iCount = 0
			While ($sfxAddString <> "" And $iCount < 4)
				if StringRegExp($sfxAddString, '^[\d\.]') Then
					$aSFX_add[$iCount] &= StringLeft($sfxAddString, 1)
					$wasNum = 1
				Else
					if $wasNum Then $iCount+=1; end of number string. new index
					$wasNum = 0
				EndIf
				$sfxAddString = StringTrimLeft($sfxAddString, 1)

				;append the rest of the string
				if $iCount = 3 Then
					$aSFX_add[$iCount] &= $sfxAddString
					Local $arr1=StringRegExp($sfxAddString, '(\d+)\s-\s(\d+)', $STR_REGEXPARRAYGLOBALMATCH)
					;_ArrayDisplay($arr1)
					For $iI = 0 to (UBound($arr1)-1) step 2
						ConsoleWrite("i= "&$iI&@CRLF)
						For $iJ = Int($arr1[$iI]) To Int($arr1[$iI+1])
							$aFrames[$iJ] = 1
						Next
					Next
					$iCount+=1
				EndIf
			WEnd
;~ 			_ArrayDisplay($aSFX_add)
			;_ArrayDisplay($aFrames)

			fn_Fill_SpriteTab()


		EndIf
	EndIf
EndFunc

Func fn_Export_QDT()
	Local $sOutFileName = "TEST"
	Local $sOutTmp, $iIdx

	if ($exportFileName <> "") Then
		$iIdx = StringInStr($exportFileName, "\",1, -1)
		If $iIdx Then
			$sOutTmp = StringTrimLeft($exportFileName, $iIdx)
			ConsoleWrite("!outname1= "&$sOutTmp&@CRLF)
			$iIdx = StringInStr($sOutTmp, ".",1, -1)
			If $iIdx Then
				$sOutFileName = StringLeft($sOutTmp, $iIdx-1)
				ConsoleWrite("!outname2= "&$sOutFileName&@CRLF)
			EndIf
		EndIf
	EndIf


	Local $filePath =  FileSaveDialog("kingpin sprites .qdt", $fileOpenDialogPath, "Quake data file (*.qdt)|All files (*.*)", 0, $sOutFileName, $KPModelSkins)
	If  @error  Then
		fn_MSG_box("No file was saved.")
	Else
		Local $hFile= FileOpen($filePath, $FO_OVERWRITE + $FO_CREATEPATH+$FO_UTF8_NOBOM)
		If not ($hFile = -1) Then
			Local $sSfxText[21], $sFrameRng = "", $iI
			fn_Get_SpriteTab_Data()

			fn_SetCurrentFolder($filePath)

			if ($exportFileName = "") Then
				$iIdx = StringInStr($filePath, "\",1, -1)
				If $iIdx Then
					$sOutTmp = StringTrimLeft($filePath, $iIdx)
					ConsoleWrite("!outname3= "&$sOutTmp&@CRLF)
					$iIdx = StringInStr($sOutTmp, ".",1, -1)
					If $iIdx Then
						$sOutFileName = StringLeft($sOutTmp, $iIdx-1)
						ConsoleWrite("!outname4= "&$sOutFileName&@CRLF)
					EndIf
				EndIf
			EndIf


			For $iI = 0 to 9
				If($aFrameRange[$iI][0] >= 0) and ($aFrameRange[$iI][1] >= 0) and ($aFrameRange[$iI][0] <= $aFrameRange[$iI][1]) Then
					$sFrameRng &= $aFrameRange[$iI][0] &" - "& $aFrameRange[$iI][1]& " "
				EndIf
			Next

			$sSfxText[0] =						'// Add SFX to gun' &@CRLF& _
												'$sfx_load ' & $sOutFileName&'   //.mdx to load' &@CRLF& _
												'' &@CRLF& _
												'$sfx_define //Define Index' & @CRLF & _
							$aSFX_define[0]	& 	'     // type (fire/smoke/blood)' &@CRLF
			$sSfxText[1] =	$aSFX_define[1]	&	'		// flags' &@CRLF
			$sSfxText[2] =	$aSFX_define[2]	&	'		// VEL_TYPE_UP (will move upwards)' &@CRLF
			$sSfxText[3] =	$aSFX_define[3]	&	'       // vel_speed' &@CRLF
			$sSfxText[4] =	$aSFX_define[4]	&	'		// gravity' &@CRLF
			$sSfxText[5] =	$aSFX_define[5]	&	'		// spawn interval, 2 = 0.1 seconds' &@CRLF
			$sSfxText[6] =	$aSFX_define[6]	&	'		// random spawn interval (sprite will be spawned 80% of the time)' &@CRLF
			$sSfxText[7] =	$aSFX_define[7]	&	'      // start alpha' &@CRLF
			$sSfxText[8] =	$aSFX_define[8]	&	'		// end alpha' &@CRLF
			$sSfxText[9] =	$aSFX_define[9]	&	'      // fadein time' &@CRLF
			$sSfxText[10] =	$aSFX_define[10]&	'      // lifetime' &@CRLF
			$sSfxText[11] =	$aSFX_define[11]&	'   	// random time scale (fadein and lifetime will be multiplied by (x * 0.5), where x is a random number between -1 and 1' &@CRLF
			$sSfxText[12] =	$aSFX_define[12]&	'       // start width' &@CRLF
			$sSfxText[13] =	$aSFX_define[13]&	'       // end width' &@CRLF
			$sSfxText[14] =	$aSFX_define[14]&	'       // start height' &@CRLF
			$sSfxText[15] =	$aSFX_define[15]&	'       // end height' &@CRLF
			$sSfxText[16] =	$aSFX_define[16]&	'      // random size scale (same as random time scale, but effects only sizes)' &@CRLF& _
												'' &@CRLF& _
												'$sfx_add' &@CRLF
			$sSfxText[17] = $aSFX_add[0]&		'   // INDEX (assigned to the first vertex)' &@CRLF
			$sSfxText[18] = $aSFX_add[1]&		'		// uses the first sfx_define (above)' &@CRLF
			$sSfxText[19] = $aSFX_add[2]&		'   // tells the engine to use the above INDEX # is a 0=vertex / 1=Triangle' &@CRLF
			$sSfxText[20] = $sFrameRng&			'  // 0-based frame ranges to enable the effect for <from - to> <from - to>' &@CRLF & _
												'' &@CRLF& _
												'$sfx_save ' &$sOutFileName& '   //.mdx to save' &@CRLF& ' '

			For $iI = 0 to 20
				FileWrite($hFile, $sSfxText[$iI])
			Next

			FileClose($hFile)
			fn_MSG_box("File saved.")
		EndIf
	EndIf
EndFunc

Func Combo1_SFX_TypeChange()
	_ResourceSetImageToCtrl($Icon_spr,"spr_" & _GUICtrlComboBox_GetCurSel($Combo1_SFX_Type) )
EndFunc
#EndRegion ;==>end sfx

#Region ;==> SPRITE TAB. SFX flags
Func Button_flagsClick()
	Local $aPos = WinGetPos ( $KPModelSkins )
							;from left,  from top
	WinMove($DMFLAGS, "", $aPos[0]+7, $aPos[1]+28)
	GUISetState(@SW_DISABLE,$KPModelSkins)
	GUISetState(@SW_SHOW,$DMFLAGS)
EndFunc

Func DMFLAGSClose()
	Local $tmpFlags = 0
	GUISetState(@SW_HIDE, $DMFLAGS)
	GUISetState(@SW_ENABLE, $KPModelSkins )
	GUISetState(@SW_RESTORE, $KPModelSkins)
	fn_Calculate_flags()
EndFunc

Func fn_Calculate_flags()
	Local $tmpFlags =0
	If _IsChecked($box_flags_1) Then $tmpFlags = BitOR($tmpFlags, 1)
	If _IsChecked($box_flags_2) Then $tmpFlags = BitOR($tmpFlags, 2)
	If _IsChecked($box_flags_4) Then $tmpFlags = BitOR($tmpFlags, 4)
	If _IsChecked($box_flags_8) Then $tmpFlags = BitOR($tmpFlags, 8)
	If _IsChecked($box_flags_16) Then $tmpFlags = BitOR($tmpFlags, 16)
	If _IsChecked($box_flags_32) Then $tmpFlags = BitOR($tmpFlags, 32)
	If _IsChecked($box_flags_64) Then $tmpFlags = BitOR($tmpFlags, 64)
	If _IsChecked($box_flags_128) Then $tmpFlags = BitOR($tmpFlags, 128)
	If _IsChecked($box_flags_256) Then $tmpFlags = BitOR($tmpFlags, 256)
	If _IsChecked($box_flags_512) Then $tmpFlags = BitOR($tmpFlags, 512)
 	If _IsChecked($box_flags_1024) Then $tmpFlags = BitOR($tmpFlags, 1024)
;~ 	If _IsChecked($box_flags_2048) Then $tmpFlags = BitOR($tmpFlags, 2048)
;~ 	If _IsChecked($box_flags_4096) Then $tmpFlags = BitOR($tmpFlags, 4096)
;~ 	If _IsChecked($box_flags_8192) Then $tmpFlags = BitOR($tmpFlags, 8192)
;~ 	If _IsChecked($box_flags_16384) Then $tmpFlags = BitOR($tmpFlags, 16384)
;~ 	If _IsChecked($box_flags_32768) Then $tmpFlags = BitOR($tmpFlags, 32768)

	GUICtrlSetData($Input1_flags,  $tmpFlags)
EndFunc

#EndRegion

#Region ;==> SCALE TAB
; buttons
Func CheckboxScaleClick()
	fn_Set_ScaleInput()
EndFunc
Func btn_scale_centreClick()
	fn_scale_centreModel()
EndFunc
Func btn_scale_dropClick()
	fn_scale_dropToFloor()
EndFunc

Func fn_scale_centreModel()
	Local $tmpScale[6]
	$tmpScale[0] = Number( GUICtrlRead($InputScale_1), $NUMBER_DOUBLE)
	$tmpScale[1] = Number( GUICtrlRead($InputScale_2), $NUMBER_DOUBLE)
	$tmpScale[2] = Number( GUICtrlRead($InputScale_3), $NUMBER_DOUBLE)
	$tmpScale[3] = Number( GUICtrlRead($InputScale_4), $NUMBER_DOUBLE)
	$tmpScale[4] = Number( GUICtrlRead($InputScale_5), $NUMBER_DOUBLE)
	$tmpScale[5] = Number( GUICtrlRead($InputScale_6), $NUMBER_DOUBLE)

	Local $xTotal = ($tmpScale[0] - $tmpScale[3]) / 2
	Local $yTotal = ($tmpScale[1] - $tmpScale[4]) / 2
	Local $zTotal = ($tmpScale[2] - $tmpScale[5]) / 2

	GUICtrlSetData($InputScale_1, $xTotal)
	GUICtrlSetData($InputScale_2, $yTotal)
	GUICtrlSetData($InputScale_3, $zTotal)
	GUICtrlSetData($InputScale_4, -$xTotal)
	GUICtrlSetData($InputScale_5, -$yTotal)
	GUICtrlSetData($InputScale_6, -$zTotal)
EndFunc

Func fn_scale_dropToFloor()
	Local $zMax = Number( GUICtrlRead($InputScale_3), $NUMBER_DOUBLE)
	Local $zMin = Number( GUICtrlRead($InputScale_6), $NUMBER_DOUBLE)
	local $fTotal = -15 + ($zMax - $zMin)

	GUICtrlSetData($InputScale_3, $fTotal)
	GUICtrlSetData($InputScale_6, "-15.0")
EndFunc

Func fn_Reset_Scale()
	GUICtrlSetState($CheckboxScale, $GUI_UNCHECKED)
	fn_Set_ScaleInput()
EndFunc

Func fn_Set_ScaleInput()
	if _IsChecked($CheckboxScale) Then
		GUICtrlSetState($InputScale_1, $GUI_ENABLE)
		GUICtrlSetState($InputScale_2, $GUI_ENABLE)
		GUICtrlSetState($InputScale_3, $GUI_ENABLE)
		GUICtrlSetState($InputScale_4, $GUI_ENABLE)
		GUICtrlSetState($InputScale_5, $GUI_ENABLE)
		GUICtrlSetState($InputScale_6, $GUI_ENABLE)
		GUICtrlSetState($btn_scale_centre, $GUI_ENABLE)
		GUICtrlSetState($btn_scale_drop, $GUI_ENABLE)
	Else
		GUICtrlSetState($InputScale_1, $GUI_DISABLE)
		GUICtrlSetState($InputScale_2, $GUI_DISABLE)
		GUICtrlSetState($InputScale_3, $GUI_DISABLE)
		GUICtrlSetState($InputScale_4, $GUI_DISABLE)
		GUICtrlSetState($InputScale_5, $GUI_DISABLE)
		GUICtrlSetState($InputScale_6, $GUI_DISABLE)
		GUICtrlSetState($btn_scale_centre, $GUI_DISABLE)
		GUICtrlSetState($btn_scale_drop, $GUI_DISABLE)
	EndIf
EndFunc

Func fn_Fill_Scale()
	GUICtrlSetData($InputScale_1, $model_DATA_scale[3] + ($model_DATA_scale[0]*255))
	GUICtrlSetData($InputScale_2, $model_DATA_scale[4] + ($model_DATA_scale[1]*255))
	GUICtrlSetData($InputScale_3, $model_DATA_scale[5] + ($model_DATA_scale[2]*255))
	GUICtrlSetData($InputScale_4, $model_DATA_scale[3])
	GUICtrlSetData($InputScale_5, $model_DATA_scale[4])
	GUICtrlSetData($InputScale_6, $model_DATA_scale[5])
EndFunc

Func fn_Update_Scale()
	if _IsChecked($CheckboxScale) Then
		Local $tmpScale[6]
		$tmpScale[0] = Number( GUICtrlRead($InputScale_1), $NUMBER_DOUBLE)
		$tmpScale[1] = Number( GUICtrlRead($InputScale_2), $NUMBER_DOUBLE)
		$tmpScale[2] = Number( GUICtrlRead($InputScale_3), $NUMBER_DOUBLE)
		$tmpScale[3] = Number( GUICtrlRead($InputScale_4), $NUMBER_DOUBLE)
		$tmpScale[4] = Number( GUICtrlRead($InputScale_5), $NUMBER_DOUBLE)
		$tmpScale[5] = Number( GUICtrlRead($InputScale_6), $NUMBER_DOUBLE)

		$model_DATA_scale[0] = ($tmpScale[0] - $tmpScale[3]) * 0.003921568627451
		$model_DATA_scale[1] = ($tmpScale[1] - $tmpScale[4]) * 0.003921568627451
		$model_DATA_scale[2] = ($tmpScale[2] - $tmpScale[5]) * 0.003921568627451
		$model_DATA_scale[3] = $tmpScale[3]
		$model_DATA_scale[4] = $tmpScale[4]
		$model_DATA_scale[5] = $tmpScale[5]
		;GUICtrlSetData($InputScale_2, $model_DATA_scale[4] + ($model_DATA_scale[1]*256))
	EndIf

	ConsoleWrite("x="&$model_DATA_scale[0]& " y="&$model_DATA_scale[1]& "  z="&$model_DATA_scale[2]& " x="&$model_DATA_scale[3]& " y="&$model_DATA_scale[4]& " z="&$model_DATA_scale[5]& @CRLF)

EndFunc

#EndRegion

#Region ;==> ICON INCLUDE
_ResourceSetImageToCtrl($Icon_spr,"spr_31")
;==> Resources.au3 by Zedna
Func _ResourceGet($ResName, $ResLang = 0) ; $RT_RCDATA = 10
	Local Const $IMAGE_BITMAP = 0
	Local $hInstance, $hBitmap, $InfoBlock, $GlobalMemoryBlock, $MemoryPointer, $ResSize

	;If $DLL = -1 Then
	  $hInstance = _WinAPI_GetModuleHandle("")
	 ; $hInstance = _WinAPI_LoadLibraryEx($DLL, $LOAD_LIBRARY_AS_DATAFILE)

	If $hInstance = 0 Then Return SetError(1, 0, 0)

	$hBitmap = _WinAPI_LoadImage($hInstance, $ResName, $IMAGE_BITMAP, 0, 0, 0)
	If @error Then Return SetError(2, 0, 0)
	Return $hBitmap ; returns handle to Bitmap

EndFunc


Func _ResourceSetImageToCtrl($CtrlId, $ResName) ; $RT_RCDATA = 10
	Local $ResData

	$ResData = _ResourceGet($ResName, 0)
	If @error Then Return SetError(1, 0, 0)

	_SetBitmapToCtrl($CtrlId, $ResData)
	If @error Then Return SetError(2, 0, 0)

	Return 1
EndFunc

; internal helper function
; thanks for improvements Melba
Func _SetBitmapToCtrl($CtrlId, $hBitmap)
    Local Const $STM_SETIMAGE = 0x0172
    Local Const $STM_GETIMAGE = 0x0173
    Local Const $BM_SETIMAGE = 0xF7
    Local Const $BM_GETIMAGE = 0xF6
    Local Const $IMAGE_BITMAP = 0
    Local Const $SS_BITMAP = 0x0E
    Local Const $BS_BITMAP = 0x0080
    Local Const $GWL_STYLE = -16

    Local $hWnd, $hPrev, $Style, $iCtrl_SETIMAGE, $iCtrl_GETIMAGE, $iCtrl_BITMAP

    $hWnd = GUICtrlGetHandle($CtrlId)
    If $hWnd = 0 Then Return SetError(1, 0, 0)


    $CtrlId = _WinAPI_GetDlgCtrlID($hWnd) ; support for $CtrlId = -1
    If @error Then Return SetError(2, 0, 0)


    ; determine control class and adjust constants accordingly
    Switch _WinAPI_GetClassName($CtrlId)
        Case "Button" ; button,checkbox,radiobutton,groupbox
            $iCtrl_SETIMAGE = $BM_SETIMAGE
            $iCtrl_GETIMAGE = $BM_GETIMAGE
            $iCtrl_BITMAP = $BS_BITMAP
        Case "Static" ; picture,icon,label
            $iCtrl_SETIMAGE = $STM_SETIMAGE
            $iCtrl_GETIMAGE = $STM_GETIMAGE
            $iCtrl_BITMAP = $SS_BITMAP
        Case Else
            Return SetError(3, 0, 0)
	EndSwitch

	; set SS_BITMAP/BS_BITMAP style to the control
    $Style = _WinAPI_GetWindowLong($hWnd, $GWL_STYLE)
    If @error Then Return SetError(4, 0, 0)
    _WinAPI_SetWindowLong($hWnd, $GWL_STYLE, BitOR($Style, $iCtrl_BITMAP))
    If @error Then Return SetError(5, 0, 0)

	; set image to the control
    $hPrev  = _SendMessage($hWnd, $iCtrl_SETIMAGE, $IMAGE_BITMAP, $hBitmap)
    If @error Then Return SetError(6, 0, 0)

    If $hPrev Then _WinAPI_DeleteObject($hPrev)

	Return 1
EndFunc
;==> END Resources.au3
#EndRegion


While 1
	Sleep(100)
WEnd
